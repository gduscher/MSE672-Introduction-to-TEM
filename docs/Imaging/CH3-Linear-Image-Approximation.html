
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Registration of Images in a Stack &#8212; Introduction to Transmisison Electron Microscopy</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Introduction to Transmisison Electron Microscopy</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Foreword (ReadME)
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Introduction/CH1_00-Introduction.html">
   1. Introduction to this Jupyter Lecture Notebook-Book
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Introduction/CH1_01-Introduction_Python.html">
     1.4. Introduction to Python as it is used in this lecture
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Introduction/CH1_02-Prerequisites.html">
     1.5. Prerequisites
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Introduction/CH1_03-Data_Representation.html">
     1.6. Matplotlib and Numpy for Micrographs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Introduction/CH1_04-Open_File.html">
     1.7. Open DM3 Images, Spectra, Spectrum-Images and  Image-Stacks with pyNSID
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Introduction/CH1_05-Course_Organization.html">
     1.8. Course Organization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Introduction/CH1_06-Overview.html">
     1.9. Overview Notebook
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Introduction/CH1_07-Electron-Optics.html">
     1.10. Electron Optics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Introduction/install_conda.html">
     1.11. Installation on your own computer
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Introduction/computer_resources.html">
     1.12. Setting up computing resources
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Diffraction/CH2_00-Diffraction.html">
   2. Chapter 2:  Diffraction
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_01-Electron.html">
     2.2. The Electron
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_02-Atomic_Form_Factor.html">
     2.3. Atomic Form Factor
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_03-Basic_Crystallography.html">
     2.4. Basic Crystallography
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_04-Structure_Factors.html">
     2.5. Structure Factors
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_05-Diffraction_Rings.html">
     2.6. Analyzing Ring Diffraction Pattern
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_06-Kinematic_Scattering_Geometry.html">
     2.7. Kinematic Scattering Geometry
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_07-Plotting_Diffraction_Pattern.html">
     2.8. Plotting Diffraction Pattern
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_08-Spot_Diffraction_Pattern.html">
     2.9. Analyzing Spot Diffraction Pattern
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_09-Unit_Cell.html">
     2.10. Unic Cell Determination and Stereographic Projection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_10-Kikuchi_Lines.html">
     2.11. Kikuchi Lines
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_11-HOLZ_Lines.html">
     2.12. HOLZ Lines
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_12-HOLZ_Example.html">
     2.13. Lattice Determination with HOLZ
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_D01-Bloch.html">
     2.16. Bethe Theory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_D02-Multislice.html">
     2.17. Multislice Algorithm
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Diffraction/CH2_D03-Multislice_CBED.html">
     2.18. CBED - Multislice Algorithm
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="CH3_00-Imaging.html">
   3. Chapter 3: Imaging
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="CH3_01-Resolution.html">
     3.2. Resolution Limit
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="CH3_03-CTF.html">
     3.3. Contrast Transfer Function
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="CH3_04-Linear_Image_Approximation.html">
     3.4. Linear Image Approximation: Weak Phase Object
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="CH3_05-Defocus_Thickness.html">
     3.5. Defocus-Thickness Map with Multislice Algorithm
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="CH3_06-Image_Processing.html">
     3.6. Image Processing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="CH3_07-Image_Analysis.html">
     3.7. Image Analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="CH3_08-Thermal_Diffuse_Scattering.html">
     3.9. Thermal-Diffuse Scattering
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="CH3_09-Z_Contrast.html">
     3.10. Z-Contrast Imaging
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="CH3_10-Ronchigram.html">
     3.11. Ronchigram
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Spectroscopy/CH4_00-Spectroscopy.html">
   4. Navigation
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Spectroscopy/CH4_01-Introduction.html">
     4.1. Introduction to  Electron Energy-Loss Spectroscopy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Spectroscopy/CH4_02-Fit_Zero_Loss.html">
     4.2. Fit of Zero-Loss Peak
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Spectroscopy/CH4_03-Drude.html">
     4.3. Analysing Low-Loss Spectra with Drude Theory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Spectroscopy/CH4_07-Introduction_Core_Loss.html">
     4.4. Introduction to Core-Loss Spectroscopy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Spectroscopy/CH4_08-Chemical_Composition.html">
     4.5. Chemical Composition in Core-Loss Spectra
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Spectroscopy/CH4_09-Analyse_Core_Loss.html">
     4.6. Analysis of Core-Loss Spectra
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Spectroscopy/CH4_10-ELNES.html">
     4.7. Energy-Loss Near-Edge Structure
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Spectroscopy/CH4_12-Introduction_X_Rays.html">
     4.8. Chapter 4
     <span class="xref myst">
      Spectroscopy
     </span>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Spectroscopy/CH4_13-Bremsstrahlung.html">
     4.10. Chapter 4
     <span class="xref myst">
      Spectroscopy
     </span>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Spectroscopy/CH4_14-Characteristic_X_Rays.html">
     4.12. Chapter 4
     <span class="xref myst">
      Spectroscopy
     </span>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Spectroscopy/CH4_15-Detector.html">
     4.14. Chapter 4
     <span class="xref myst">
      Spectroscopy
     </span>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Spectroscopy/CH4_16-Analyze_EDS_Spectrum.html">
     4.18. Chapter 4
     <span class="xref myst">
      Spectroscopy
     </span>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Spectroscopy/CH4_17-Quantify_EDS_Spectrum.html">
     4.21. Chapter 4
     <span class="xref myst">
      Spectroscopy
     </span>
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Homework/homework.html">
   5. Homework
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Homework/Homework01.html">
     5.1. Homework 1
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Homework/Homework02.html">
     5.2. Homework 2
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Homework/Homework03.html">
     5.3. Homework 3
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Homework/Homework04.html">
     5.4. Homework 4
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Homework/Homework05-CBED.html">
     5.5. HW5:  Analyzing CBED Pattern
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Homework/Homework06-TwoBeam.html">
     5.6. HW6:  Analyzing CBED Pattern in Two Beam Condition
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Homework/Homework07-Dynamic_CBED.html">
     5.7. HW7:  Simulating CBED Pattern
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/gduscher/MSE672-Introduction-to-TEM/main?urlpath=tree/docs/Imaging/CH3-Linear-Image-Approximation.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/gduscher/MSE672-Introduction-to-TEM"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/gduscher/MSE672-Introduction-to-TEM/issues/new?title=Issue%20on%20page%20%2FImaging/CH3-Linear-Image-Approximation.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/Imaging/CH3-Linear-Image-Approximation.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#first-we-import-the-usual-libraries">
   First we import the usual libraries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#projected-potential-from-parametrization-of-atomic-form-factor">
   Projected Potential from Parametrization of Atomic Form Factor
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-quarter-of-projected-atom-potential">
     Plot quarter of projected atom potential
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-full-projected-atom-potential">
     Plot full projected atom potential
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#embedd-atoms-in-images">
     Embedd atoms in images
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#projected-potential-of-supercell">
   Projected Potential of Supercell
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#all-together-in-a-function">
     All together in a function
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#transmission-function-for-very-thin-specimen">
   Transmission Function for Very Thin Specimen
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aberration-function">
   Aberration Function
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#image-simulation-in-weak-phase-approximation">
   Image Simulation in Weak Phase Approximation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#influence-of-aberrations-on-image">
   Influence of Aberrations on Image
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Registration of Images in a Stack</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#first-we-import-the-usual-libraries">
   First we import the usual libraries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#projected-potential-from-parametrization-of-atomic-form-factor">
   Projected Potential from Parametrization of Atomic Form Factor
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-quarter-of-projected-atom-potential">
     Plot quarter of projected atom potential
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-full-projected-atom-potential">
     Plot full projected atom potential
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#embedd-atoms-in-images">
     Embedd atoms in images
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#projected-potential-of-supercell">
   Projected Potential of Supercell
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#all-together-in-a-function">
     All together in a function
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#transmission-function-for-very-thin-specimen">
   Transmission Function for Very Thin Specimen
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aberration-function">
   Aberration Function
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#image-simulation-in-weak-phase-approximation">
   Image Simulation in Weak Phase Approximation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#influence-of-aberrations-on-image">
   Influence of Aberrations on Image
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <p><font size = "5"> <strong>Chapter 2:  <span class="xref myst">Imaging</span></strong> </font></p>
<hr style="height:1px;border-top:4px solid #FF8200" />
<section class="tex2jax_ignore mathjax_ignore" id="registration-of-images-in-a-stack">
<h1>Registration of Images in a Stack<a class="headerlink" href="#registration-of-images-in-a-stack" title="Permalink to this headline">#</a></h1>
<p>part of</p>
<p><font size = "5"> <strong><span class="xref myst">Analysis of Transmission Electron Microscope Data</span></strong></font></p>
<p>by Gerd Duscher, 2019</p>
<p>Microscopy Facilities<br>
Joint Institute of Advanced Materials<br>
The University of Tennessee, Knoxville</p>
<p>Model based analysis and quantification of data acquired with transmission electron microscopes</p>
<section id="first-we-import-the-usual-libraries">
<h2>First we import the usual libraries<a class="headerlink" href="#first-we-import-the-usual-libraries" title="Permalink to this headline">#</a></h2>
<p>Please visit the  section for <a class="reference external" href="Ch1-Prerequesites.ipynb#TEM_Library">pyTEMlib</a> of the <span class="xref myst">Prerequesites</span> section for information of necessary packages.</p>
<p>Youâ€™ll need at least pyTEMlib version 0.7.2019.0</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import matplotlib and numpy</span>
<span class="c1">#                       use &quot;inline&quot; instead of &quot;notebook&quot; for non-interactive plots</span>
<span class="o">%</span><span class="k">pylab</span> --no-import-all widget 

<span class="kn">import</span> <span class="nn">scipy.constants</span>

<span class="c1"># Import libraries from the book</span>
<span class="kn">import</span> <span class="nn">pyTEMlib</span>
<span class="kn">import</span> <span class="nn">pyTEMlib.KinsCat</span> <span class="k">as</span> <span class="nn">ks</span>

<span class="c1"># For archiving reasons it is a good idea to print the version numbers out at this point</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pyTEM version: &#39;</span><span class="p">,</span><span class="n">pyTEMlib</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>

<span class="n">__notebook__</span> <span class="o">=</span> <span class="s1">&#39;2_Image_Registration&#39;</span>
<span class="n">__notebook_version__</span> <span class="o">=</span> <span class="s1">&#39;2020_06_27&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Populating the interactive namespace from numpy and matplotlib
Using KinsCat library version  0.5  by G.Duscher
spglib not installed; Symmetry functions of spglib disabled
pyTEM version:  0.2021.02.22
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\gduscher\Anaconda3\lib\site-packages\pyUSID\viz\__init__.py:16: FutureWarning: Please use sidpy.viz.plot_utils instead of pyUSID.viz.plot_utils. pyUSID.plot_utils will be removed in a future release of pyUSID
  warn(&#39;Please use sidpy.viz.plot_utils instead of pyUSID.viz.plot_utils. &#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="projected-potential-from-parametrization-of-atomic-form-factor">
<h2>Projected Potential from Parametrization of Atomic Form Factor<a class="headerlink" href="#projected-potential-from-parametrization-of-atomic-form-factor" title="Permalink to this headline">#</a></h2>
<p>Following Kirkland (2<span class="math notranslate nohighlight">\(^nd\)</span> edition Appendix C page 252),
the atom potential is with <span class="math notranslate nohighlight">\(r^2 = x^2+z^2+z^2\)</span> and <span class="math notranslate nohighlight">\(V(x,y,z) =V(\vec{r})\)</span>
$<span class="math notranslate nohighlight">\(
\begin{eqnarray}
v(x, y, z) &amp;=&amp;  2 \pi a_0 e_0 \int f_e(q) \exp \left( -2 \pi i \vec{q} \vec{r}  \right)  d^3r \\
&amp;=&amp; 2 \pi^2 a_0 e_0 \sum_i \frac{a_i}{r} \exp \left( -2 \pi r  \sqrt{b_i} \right) + 2\pi^{5/2} a_0 e_0 \sum_i c_i d_i^{-3/2} \exp \left(\frac{-\pi^2 r^2}{d_i} \right)
\end{eqnarray}
\)</span><span class="math notranslate nohighlight">\(
with \)</span>r^2 = x^2+z^2+z^2$</p>
<p>The <code class="docutils literal notranslate"><span class="pre">projected</span> <span class="pre">potential</span></code> is then:
$$
\begin{eqnarray}
v_z(x,y) &amp;=&amp; \int_{-\inf}^{\inf} V(x,y,z) dz \
&amp;=&amp; 4 \pi^2 a_0 e_0 \sum_i a_i K_0 \left( 2 \pi r \sqrt{b_i} \right)</p>
<ul class="simple">
<li><p>2 \pi^2 a_0 e_0 \sum_i \frac{c_i}{d_i} \exp \left( \frac{-\pi^2 r^2}{d_i} \right)\
&amp;=&amp; 2 \pi^2 a_0 e_0 \left[2 \sum_i a_i K_0 \left( 2 \pi r \sqrt{b_i} \right)
+\sum_i \frac{c_i}{d_i} \exp \left( \frac{-\pi^2 r^2}{d_i} \right) \right]
\end{eqnarray}
$<span class="math notranslate nohighlight">\(
with \)</span> r^2 = x^2 + y^2$, we need to calculate the 1D potential only, dueto the radial symmetry of atoms.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">spherical</span> <span class="pre">Bessel</span> <span class="pre">function</span></code> is providedby the <code class="docutils literal notranslate"><span class="pre">scipy</span></code> special package.</p>
<p>We will use the last of the equations in our calculation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.special</span> 

<span class="k">def</span> <span class="nf">potential_1D</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
    <span class="c1"># atomic_number.append(electronFF[tags[&#39;elements&#39;][i]][&#39;Z&#39;])</span>
    <span class="n">a0</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;Bohr radius&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e10</span>
    <span class="n">e0</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">elementary_charge</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">10</span>
    
    <span class="n">pre_factor</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">a0</span> <span class="o">*</span> <span class="n">e0</span>

    <span class="n">param</span> <span class="o">=</span> <span class="n">ks</span><span class="o">.</span><span class="n">electronFF</span><span class="p">[</span><span class="n">element</span><span class="p">]</span>  <span class="c1"># parametrized form factors</span>
    <span class="n">fL</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="mi">0</span>  <span class="c1"># Lorentzian term</span>
    <span class="n">fG</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="mi">0</span>  <span class="c1"># Gaussian term</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">fL</span> <span class="o">+=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;fa&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">k0</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;fb&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">fG</span> <span class="o">+=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;fc&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;fd&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;fd&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

       
    <span class="k">return</span> <span class="n">pre_factor</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">fL</span> <span class="o">+</span> <span class="n">fG</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="plot-quarter-of-projected-atom-potential">
<h3>Plot quarter of projected atom potential<a class="headerlink" href="#plot-quarter-of-projected-atom-potential" title="Permalink to this headline">#</a></h3>
<p>We now use this function to plot a projected atom potential up in a 1nm by 1nm image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pixel_size</span> <span class="o">=</span> <span class="mf">0.01</span>


<span class="n">a_nx</span> <span class="o">=</span> <span class="n">a_ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">pixel_size</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a_nx</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">a_ny</span><span class="p">]</span> <span class="o">*</span> <span class="n">pixel_size</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span> 
<span class="n">r</span><span class="p">[</span><span class="n">r</span><span class="o">&lt;</span><span class="n">pixel_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span><span class="o">/</span><span class="mi">4</span>
<span class="n">atom_potential</span> <span class="o">=</span> <span class="n">potential_1D</span><span class="p">(</span><span class="s1">&#39;Si&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">atom_potential</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">a_nx</span><span class="o">*</span><span class="n">pixel_size</span><span class="p">,</span><span class="n">a_ny</span><span class="o">*</span><span class="n">pixel_size</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;distance (nm)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "24e358b8fe6b45d6bb96a9452b335fcf", "version_major": 2, "version_minor": 0}
</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;distance (nm)&#39;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-full-projected-atom-potential">
<h3>Plot full projected atom potential<a class="headerlink" href="#plot-full-projected-atom-potential" title="Permalink to this headline">#</a></h3>
<p>Now, that we have a quarter of the atom potential, we make the round one.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">atom_potential_round</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span><span class="o">*</span><span class="n">a_nx</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">a_ny</span><span class="p">])</span>
<span class="n">atom_potential_round</span><span class="p">[</span><span class="n">a_nx</span><span class="p">:,</span><span class="n">a_ny</span><span class="p">:]</span> <span class="o">=</span> <span class="n">atom_potential</span>
<span class="n">atom_potential_round</span><span class="p">[</span><span class="n">a_nx</span><span class="p">:,:</span><span class="n">a_ny</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">atom_potential</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">atom_potential_round</span><span class="p">[:</span><span class="n">a_nx</span><span class="p">,</span><span class="n">a_ny</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">atom_potential</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">atom_potential_round</span><span class="p">[:</span><span class="n">a_nx</span><span class="p">,:</span><span class="n">a_ny</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">atom_potential</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">atom_potential_round</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">a_nx</span><span class="o">*</span><span class="n">pixel_size</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">a_ny</span><span class="o">*</span><span class="n">pixel_size</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;distance (nm)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9d9fd152dff24a309c7b385dc4ef32a7", "version_major": 2, "version_minor": 0}
</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;distance (nm)&#39;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="embedd-atoms-in-images">
<h3>Embedd atoms in images<a class="headerlink" href="#embedd-atoms-in-images" title="Permalink to this headline">#</a></h3>
<p>We place the atom in the corner of a matrix with the same size as the image to be simulated.</p>
<p>With the numpy roll function we now can move this atom wherever we want.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nx</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">=</span>  <span class="mi">512</span>

<span class="n">atom_potential_corner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>

<span class="n">atom_potential_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a_nx</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">a_ny</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_potential</span>
<span class="n">atom_potential_corner</span><span class="p">[</span><span class="n">nx</span><span class="o">-</span><span class="n">a_nx</span><span class="p">:,</span><span class="mi">0</span><span class="p">:</span><span class="n">a_ny</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">atom_potential</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">atom_potential_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a_nx</span><span class="p">,</span><span class="n">ny</span><span class="o">-</span><span class="n">a_ny</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">atom_potential</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">atom_potential_corner</span><span class="p">[</span><span class="n">nx</span><span class="o">-</span><span class="n">a_nx</span><span class="p">:,</span><span class="n">ny</span><span class="o">-</span><span class="n">a_ny</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">atom_potential</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">atom_potential_corner</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "07d20ef35ca744479aab23195c240304", "version_major": 2, "version_minor": 0}
</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x1f208ab7190&gt;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="projected-potential-of-supercell">
<h2>Projected Potential of Supercell<a class="headerlink" href="#projected-potential-of-supercell" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">potential_unit_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>
<span class="n">atom_potential_corner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>

<span class="n">potential</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>

<span class="n">atom_potential_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a_nx</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">a_ny</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_potential</span>
<span class="n">atom_potential_corner</span><span class="p">[</span><span class="n">nx</span><span class="o">-</span><span class="n">a_nx</span><span class="p">:,</span><span class="mi">0</span><span class="p">:</span><span class="n">a_ny</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">atom_potential</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">atom_potential_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a_nx</span><span class="p">,</span><span class="n">ny</span><span class="o">-</span><span class="n">a_ny</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">atom_potential</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">atom_potential_corner</span><span class="p">[</span><span class="n">nx</span><span class="o">-</span><span class="n">a_nx</span><span class="p">:,</span><span class="n">ny</span><span class="o">-</span><span class="n">a_ny</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">atom_potential</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="n">unit_cell_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span> <span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]</span> <span class="p">])</span><span class="o">*</span><span class="n">nx</span><span class="o">/</span><span class="mi">8</span>
<span class="n">unit_cell_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unit_cell_base</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">unit_cell_base</span><span class="p">:</span>
    <span class="n">potential_unit_cell</span> <span class="o">=</span> <span class="n">potential_unit_cell</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">atom_potential_corner</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">pos</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">potential</span> <span class="o">=</span> <span class="n">potential</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">potential_unit_cell</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">64</span><span class="p">,</span><span class="n">j</span><span class="o">*</span><span class="mi">64</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="mi">64</span><span class="o">*</span><span class="mf">0.02</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">potential</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">potential</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 0]
[32 32]
1.28
1.0222392829586504e-17
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "ea56aa07797b4582b5e38a715f91610d", "version_major": 2, "version_minor": 0}
</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x1f208b231f0&gt;
</pre></div>
</div>
</div>
</div>
<section id="all-together-in-a-function">
<h3>All together in a function<a class="headerlink" href="#all-together-in-a-function" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">potential_2D</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">n_cell_x</span><span class="p">,</span> <span class="n">n_cell_y</span><span class="p">,</span> <span class="n">lattice_parameter</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
    <span class="n">n_cell_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">n_cell_x</span><span class="p">))</span>
    <span class="n">n_cell_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">n_cell_y</span><span class="p">))</span>
    
    <span class="n">pixel_size</span> <span class="o">=</span> <span class="n">lattice_parameter</span><span class="o">/</span><span class="p">(</span><span class="n">nx</span><span class="o">/</span><span class="n">n_cell_x</span><span class="p">)</span>
    
    <span class="n">a_nx</span> <span class="o">=</span> <span class="n">a_ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">pixel_size</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a_nx</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">a_ny</span><span class="p">]</span> <span class="o">*</span> <span class="n">pixel_size</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nx</span><span class="o">/</span><span class="n">n_cell_x</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span> 
    <span class="n">r</span><span class="p">[</span><span class="n">r</span><span class="o">&lt;</span><span class="n">pixel_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span><span class="o">/</span><span class="mi">4</span>
    <span class="n">atom_potential</span> <span class="o">=</span> <span class="n">potential_1D</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>

    <span class="n">potential</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>

    <span class="n">atom_potential_corner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>
    <span class="n">atom_potential_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a_nx</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">a_ny</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_potential</span>
    <span class="n">atom_potential_corner</span><span class="p">[</span><span class="n">nx</span><span class="o">-</span><span class="n">a_nx</span><span class="p">:,</span><span class="mi">0</span><span class="p">:</span><span class="n">a_ny</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">atom_potential</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">atom_potential_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a_nx</span><span class="p">,</span><span class="n">ny</span><span class="o">-</span><span class="n">a_ny</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">atom_potential</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">atom_potential_corner</span><span class="p">[</span><span class="n">nx</span><span class="o">-</span><span class="n">a_nx</span><span class="p">:,</span><span class="n">ny</span><span class="o">-</span><span class="n">a_ny</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">atom_potential</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">unit_cell_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="o">*</span><span class="n">a</span>
    <span class="n">unit_cell_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unit_cell_base</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
    

    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">unit_cell_base</span><span class="p">:</span>
        <span class="n">potential</span> <span class="o">=</span> <span class="n">potential</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">atom_potential_corner</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">n_cell_x</span><span class="p">))):</span>
        <span class="n">potential</span> <span class="o">=</span> <span class="n">potential</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">potential</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">column</span> <span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">n_cell_y</span><span class="p">))):</span>
        <span class="n">potential</span> <span class="o">=</span> <span class="n">potential</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">potential</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">row</span> <span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">potential</span>

<span class="n">nx</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">n_cell_x</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">0.28</span>

<span class="n">potential</span> <span class="o">=</span> <span class="n">potential_2D</span><span class="p">(</span><span class="s1">&#39;Si&#39;</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">n_cell_x</span><span class="p">,</span> <span class="n">n_cell_x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]])</span>
<span class="n">pixel_size</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="p">(</span><span class="n">nx</span><span class="o">/</span><span class="n">n_cell_x</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">potential</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">nx</span><span class="o">*</span><span class="n">pixel_size</span><span class="p">,</span> <span class="n">ny</span><span class="o">*</span><span class="n">pixel_size</span><span class="p">,</span> <span class="mi">0</span> <span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "88021bde6d1542cf9e3d7673bf2f14f1", "version_major": 2, "version_minor": 0}
</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x1f21d5b3130&gt;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="transmission-function-for-very-thin-specimen">
<h2>Transmission Function for Very Thin Specimen<a class="headerlink" href="#transmission-function-for-very-thin-specimen" title="Permalink to this headline">#</a></h2>
<p>For a very thin specimen the <code class="docutils literal notranslate"><span class="pre">weak</span> <span class="pre">phase</span> <span class="pre">approximation</span></code> is the simples way to calculate a high resolution (phase contrast) image.<br />
In that approximation, the sample causes only a phase change to the incident plane wave.</p>
<p>To retrieve the exit we just multiply the transmission function <span class="math notranslate nohighlight">\(t(\vec{x})\)</span> with the plane wave <span class="math notranslate nohighlight">\(\exp (2\pi i k_z z)\)</span></p>
<div class="math notranslate nohighlight">
\[ \Psi_t(\vec{x}) = t(\vec{x}) \exp \left(2 \pi i k_z z \right) \approx t(\vec{x})  \]</div>
<p>The specimen transmission function depends on the projected potential <span class="math notranslate nohighlight">\(v_z(\vec{x})\)</span> and the interaction parameter <span class="math notranslate nohighlight">\(\sigma\)</span>:
$<span class="math notranslate nohighlight">\(t(\vec{x}) =  \exp \left( i \sigma v_z(\vec{x})\right)\)</span>$</p>
<p>with the interaction parameter <span class="math notranslate nohighlight">\(\sigma\)</span>:
$<span class="math notranslate nohighlight">\( 
\sigma = \frac{2 \pi}{\lambda V} \left(  \frac{m_0 c^2 + eV}{2m_0c^2+eV} \right) = \frac{2 \pi m  e_0 \lambda}{h^2}
\)</span><span class="math notranslate nohighlight">\(
with \)</span> m = \gamma m_0<span class="math notranslate nohighlight">\( and \)</span>eV$ the incident electron energy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">interaction_parameter</span><span class="p">(</span><span class="n">acceleration_voltage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates interaction parameter sigma</span>
<span class="sd">    </span>
<span class="sd">    Parameter</span>
<span class="sd">    ---------</span>
<span class="sd">    acceleration_voltage: float</span>
<span class="sd">        acceleration voltage in volt</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    interaction parameter: float</span>
<span class="sd">        interaction parameter (dimensionless)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">acceleration_voltage</span> <span class="c1"># in eV</span>
    <span class="n">E0</span> <span class="o">=</span> <span class="mf">510998.95</span> <span class="c1">#  m_0 c^2 in eV</span>
    
    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">ks</span><span class="o">.</span><span class="n">get_wavelength</span><span class="p">(</span><span class="n">acceleration_voltage</span><span class="p">)</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">acceleration_voltage</span>
    
    <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span> <span class="p">(</span><span class="n">wavelength</span> <span class="o">*</span> <span class="n">E</span><span class="p">)</span>  <span class="o">*</span><span class="p">(</span><span class="n">E0</span> <span class="o">+</span> <span class="n">E</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">E0</span><span class="o">+</span><span class="n">E</span><span class="p">)</span>


<span class="n">potential</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">potential</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">transmission</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">potential</span><span class="p">):</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span> <span class="n">potential</span><span class="p">)</span>
    
<span class="n">acceleration_voltage</span> <span class="o">=</span> <span class="mi">20000</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">interaction_parameter</span><span class="p">(</span><span class="n">acceleration_voltage</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">transmission</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">potential</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(512, 512)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "ba50107f9c9944a0841e922c7ea2d7aa", "version_major": 2, "version_minor": 0}
</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x1f21d3513a0&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="aberration-function">
<h2>Aberration Function<a class="headerlink" href="#aberration-function" title="Permalink to this headline">#</a></h2>
<p>The aberration function <span class="math notranslate nohighlight">\(chi(\vec{k})\)</span> is defined in reciprocal space.</p>
<p>For the calculation of <span class="math notranslate nohighlight">\(chi\)</span> we use the angles instead of reciprocal distances.</p>
<p>We came accross the aberration function before in the <span class="xref myst">contrast transfer function notebook</span>.</p>
<p>Please look up how we determined the different Scherzer foci in <span class="xref myst">contrast transfer function notebook</span>. The contrast transfer function (CTF) is just the radial average of the aberration function if all aberrations are zero except defocus (C10) and spherical aberration (C30).</p>
<p>The objective lens function (or point spread function of the eletron microscope) <span class="math notranslate nohighlight">\(H_0(\vec{k})\)</span>
is defined as:
$<span class="math notranslate nohighlight">\( 
H_0(\vec{k}) = \sin \left(\chi(\vec{k})\right)
\)</span>$
an oscillating function and at the origin of problems in electron microscopy.</p>
<p>In the TEM a Fourier transform of an image of an thin amorphous material will look similar (with noise) to the object function below. Compare those diffractograms with differnt defoci with those of our simulation.</p>
<p>Check out what the astigmatism (C12a or C12b) does to the object function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_chi</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">ab</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate aberration function chi</span>
<span class="sd">    </span>
<span class="sd">    Input:</span>
<span class="sd">    ------</span>
<span class="sd">    theta, phi: numpay array (n x m)</span>
<span class="sd">        angle meshes of the reciprocal space</span>
<span class="sd">    wavelength: float</span>
<span class="sd">        wavelength in nm</span>
<span class="sd">    ab: dict</span>
<span class="sd">        aberrations in nm should at least contain defocus (C10), and spherical abeeration (C30) </span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    chi: numpy array (nxm)</span>
<span class="sd">        aberration function </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;C10&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ab</span><span class="p">:</span>
        <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C10&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="s1">&#39;C12a&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ab</span><span class="p">:</span>
        <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C12a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="s1">&#39;C12b&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ab</span><span class="p">:</span>
        <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C12b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1"># defocus and astigmatism</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C10&#39;</span><span class="p">]</span>  <span class="o">+</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C12a&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span> <span class="o">+</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C12b&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">phi</span><span class="p">))</span>
    

    <span class="c1"># coma and three fold astigmatism</span>
    <span class="k">if</span> <span class="s1">&#39;C21a&#39;</span> <span class="ow">in</span> <span class="n">ab</span> <span class="ow">and</span> <span class="s1">&#39;C21b&#39;</span> <span class="ow">in</span> <span class="n">ab</span> <span class="ow">and</span> <span class="s1">&#39;C23a&#39;</span> <span class="ow">in</span> <span class="n">ab</span> <span class="ow">and</span> <span class="s1">&#39;C23b&#39;</span> <span class="ow">in</span> <span class="n">ab</span><span class="p">:</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C21a&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">phi</span><span class="p">)</span> <span class="o">+</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C21b&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">phi</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="mf">0.</span>
    <span class="c1"># spherical aberration</span>
    <span class="k">if</span> <span class="s1">&#39;C30&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ab</span><span class="p">:</span>
        <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C30&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="o">*</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C30&#39;</span><span class="p">]</span>
                              
    <span class="n">chi</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span><span class="o">+</span> <span class="n">t3</span>
    <span class="k">return</span> <span class="n">chi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wavelength</span>  <span class="c1"># np.power(theta,6)/6*(  ab[&#39;C50&#39;] )</span>
                           
<span class="k">def</span> <span class="nf">objective_lens_function</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">field_of_view</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">aperture_size</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Objective len function to be convoluted with exit wave to derive image function</span>
<span class="sd">    </span>
<span class="sd">    Input:</span>
<span class="sd">    ab: dict</span>
<span class="sd">        aberrations in nm should at least contain defocus (C10), and spherical abeeration (C30) </span>
<span class="sd">    nx: int</span>
<span class="sd">        number of pixel in x direction</span>
<span class="sd">    ny: int</span>
<span class="sd">        number of pixel in y direction</span>
<span class="sd">    field_of_view: float</span>
<span class="sd">        field of fiew of potential</span>
<span class="sd">    wavelength: float</span>
<span class="sd">        wavelength in nm</span>
<span class="sd">    aperture_size: float</span>
<span class="sd">        aperture size in 1/nm</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    object function: numpy array (nx x ny)</span>
<span class="sd">    extent: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Reciprocal plane in 1/nm</span>
    <span class="n">dk</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">field_of_view</span>
    <span class="n">t_xv</span><span class="p">,</span> <span class="n">t_yv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span> <span class="o">*</span><span class="n">dk</span>

    <span class="c1"># define reciprocal plane in angles</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">t_yv</span><span class="p">,</span> <span class="n">t_xv</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">t_xv</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t_yv</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">wavelength</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">&lt;</span> <span class="n">aperture_size</span> <span class="o">*</span> <span class="n">wavelength</span>

    <span class="c1"># calculate chi</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="n">make_chi</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">ab</span><span class="p">)</span>
    
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">dk</span><span class="p">,</span> <span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">dk</span><span class="p">,</span> <span class="o">-</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">dk</span><span class="p">,</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">dk</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span><span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="n">extent</span>

<span class="n">acceleration_voltage</span> <span class="o">=</span> <span class="mi">200000</span>
<span class="n">ab</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;C10&#39;</span><span class="p">:</span><span class="o">-</span><span class="mf">84.0</span><span class="p">,</span> <span class="s1">&#39;C12a&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;C12b&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;C30&#39;</span><span class="p">:</span> <span class="mf">2.2</span><span class="o">*</span><span class="mf">1e6</span><span class="p">}</span> <span class="c1"># aberrations in nm</span>

<span class="n">wavelength</span> <span class="o">=</span> <span class="n">ks</span><span class="o">.</span><span class="n">get_wavelength</span><span class="p">(</span><span class="n">acceleration_voltage</span><span class="p">)</span>

<span class="n">objective_lens</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="n">objective_lens_function</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="o">*</span><span class="n">pixel_size</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mf">.18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">objective_lens</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;reciprocal distance (1/nm)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b46a6d8460f64deab8b40bcb7d75e477", "version_major": 2, "version_minor": 0}
</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;reciprocal distance (1/nm)&#39;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="image-simulation-in-weak-phase-approximation">
<h2>Image Simulation in Weak Phase Approximation<a class="headerlink" href="#image-simulation-in-weak-phase-approximation" title="Permalink to this headline">#</a></h2>
<p>In the weak phase approximation the image is just the convoltuion of the transmission function and the objective lens funtion.</p>
<p>If an aperture selects only the inner smooth part of the objetive function in Scherzer defocus, the image is naively to interpret as the dark parts as the atoms (remember the CTF is negative in that case)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">t</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">objective_lens</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">image</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">image</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "fb42f7066531411f9b768eaea9851b6c", "version_major": 2, "version_minor": 0}
</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x1f21ad99160&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="influence-of-aberrations-on-image">
<h2>Influence of Aberrations on Image<a class="headerlink" href="#influence-of-aberrations-on-image" title="Permalink to this headline">#</a></h2>
<p>Within this weak phase object aberration, we can already investigate the influence of lens aberrations on the image.</p>
<p>We do now all steps together and check the effect of the aberration, acceleration voltage, aperture, and element onto the final image (in weak phase approximation).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nx</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">n_cell_x</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">0.28</span>
<span class="n">acceleration_voltage</span> <span class="o">=</span> <span class="mi">200000</span>
<span class="n">resolution</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">ab</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;C10&#39;</span><span class="p">:</span><span class="o">-</span><span class="mf">188.0</span><span class="p">,</span> <span class="s1">&#39;C12a&#39;</span><span class="p">:</span> <span class="mf">00.0</span><span class="p">,</span> <span class="s1">&#39;C12b&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;C30&#39;</span><span class="p">:</span> <span class="mf">2.2</span><span class="o">*</span><span class="mf">1e6</span><span class="p">}</span> <span class="c1"># aberrations in nm</span>

<span class="n">potential</span> <span class="o">=</span> <span class="n">potential_2D</span><span class="p">(</span><span class="s1">&#39;Au&#39;</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">n_cell_x</span><span class="p">,</span> <span class="n">n_cell_x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]])</span>
<span class="n">pixel_size</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="p">(</span><span class="n">nx</span><span class="o">/</span><span class="n">n_cell_x</span><span class="p">)</span>

<span class="n">sigma</span> <span class="o">=</span> <span class="n">interaction_parameter</span><span class="p">(</span><span class="n">acceleration_voltage</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">transmission</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">potential</span><span class="p">)</span>

<span class="n">wavelength</span> <span class="o">=</span> <span class="n">ks</span><span class="o">.</span><span class="n">get_wavelength</span><span class="p">(</span><span class="n">acceleration_voltage</span><span class="p">)</span>

<span class="n">objective_lens</span><span class="p">,</span> <span class="n">extent_r</span> <span class="o">=</span> <span class="n">objective_lens_function</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="o">*</span><span class="n">pixel_size</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">resolution</span><span class="p">)</span>

<span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">t</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">objective_lens</span><span class="p">))</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">image</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">objective_lens</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent_r</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;reciprocal distance (1/nm)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">nx</span><span class="o">*</span><span class="n">pixel_size</span><span class="p">,</span> <span class="n">ny</span><span class="o">*</span><span class="n">pixel_size</span><span class="p">,</span> <span class="mi">0</span> <span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;distance (nm)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "1ba980fc9ec9415dbc2021e84dd22573", "version_major": 2, "version_minor": 0}
</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;distance (nm)&#39;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">#</a></h2>
<p>The weak phase object allows for a fast check on image parameters. For a quantitative image simulation we need to do dynamic scattering theory. Please go to the  <span class="xref myst">Multislice notebook</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculating the total 2D potentials for each layer</span>

<span class="k">def</span> <span class="nf">DefPot2DLayer</span><span class="p">(</span><span class="n">PixImageSize</span><span class="p">,</span> <span class="n">ImageRange</span><span class="p">,</span> <span class="n">NLayers</span><span class="p">,</span> <span class="n">MatLattice</span><span class="p">,</span> <span class="n">UnitCellPot2D</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
    <span class="n">Mat2D</span> <span class="o">=</span> <span class="n">MatLattice</span><span class="p">[:</span><span class="mi">2</span><span class="p">,:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Mat2DInv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Mat2D</span><span class="p">)</span>
    <span class="n">dnx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Mat2D</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="p">)))</span>
    <span class="n">dny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Mat2D</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="p">)))</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dnx</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dny</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="n">Pot2DLayer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="mf">0.</span>  \
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PixImageSize</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PixImageSize</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>  <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLayers</span><span class="p">)])</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLayers</span><span class="p">):</span> <span class="c1"># Layers loop</span>
        <span class="n">Pot2DInter</span> <span class="o">=</span> <span class="n">interp2d</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">UnitCellPot2D</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ScanY</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PixImageSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">ScanX</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PixImageSize</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ScanX</span> <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="n">PixImageSize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span> \
                    <span class="n">ScanY</span> <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="n">PixImageSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>\
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ImageRange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ImageRange</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                <span class="n">ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">Mat2DInv</span><span class="p">)</span><span class="o">%</span><span class="k">np</span>.array([1,1])  # Real to Direct within 1 unit cell
                <span class="n">Pot2DLayer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ScanY</span><span class="p">,</span> <span class="n">ScanX</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pot2DInter</span><span class="p">(</span><span class="n">ni</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ni</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">Mat2DInv</span><span class="p">,</span> <span class="n">dnx</span><span class="p">,</span> <span class="n">dny</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ScanX</span><span class="p">,</span> <span class="n">ScanY</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">ni</span>
    <span class="k">return</span> <span class="n">Pot2DLayer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PixImageSize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">]</span>
<span class="n">NLayers</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">Pot2DLayer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="mf">0.</span>  \
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PixImageSize</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PixImageSize</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>  <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLayers</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Pot2DLayer</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Pot2DLayer</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(10, 30, 30)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "bf45a49c8fa741329bbb99a54d0bd6cb", "version_major": 2, "version_minor": 0}
</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x1f216ec9820&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ScanY</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ScanYsize</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;line: &#39;</span><span class="p">,</span><span class="n">ScanY</span><span class="p">,</span><span class="s1">&#39; of &#39;</span><span class="p">,</span><span class="n">PixImageSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ProSize</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ScanX</span>  <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ScanXsize</span><span class="p">):</span>
        <span class="n">Phi_trans</span> <span class="o">=</span> <span class="n">Probe</span>
        <span class="k">for</span> <span class="n">NThickness</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NLevels</span> <span class="o">*</span> <span class="n">NLayers</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># NLevels depending of thickness</span>
                <span class="k">if</span> <span class="n">NThickness</span><span class="o">%</span><span class="p">(</span><span class="n">NLayers</span><span class="p">)</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                        <span class="n">CountLayer</span> <span class="o">=</span> <span class="n">NLayers</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                        <span class="n">CountLayer</span> <span class="o">=</span> <span class="n">NThickness</span><span class="o">%</span><span class="p">(</span><span class="n">NLayers</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                <span class="n">Phi_trans</span> <span class="o">=</span> <span class="n">Trans2D</span><span class="p">[</span><span class="n">CountLayer</span><span class="p">,</span> <span class="n">ScanY</span> <span class="p">:</span> <span class="n">ProSize</span> <span class="o">+</span> <span class="n">ScanY</span><span class="p">,</span>\
                                                <span class="n">ScanX</span> <span class="p">:</span><span class="n">ProSize</span> <span class="o">+</span> <span class="n">ScanX</span><span class="p">]</span> <span class="o">*</span> <span class="n">Phi_trans</span> <span class="c1"># real</span>
                <span class="n">Phi_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">Phi_trans</span><span class="p">)</span>
                <span class="n">tp1</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">Phi_trans</span><span class="p">)</span> <span class="c1"># real to reciprocal</span>
                <span class="n">tp1</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">Projector2DK</span><span class="p">[</span><span class="n">CountLayer</span><span class="p">]</span> <span class="o">*</span> <span class="n">tp1</span><span class="p">)</span> <span class="c1">#reciprocal to real</span>
                <span class="n">Phi_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">tp1</span><span class="p">)</span>
                <span class="c1">#Phi_trans[antialising] = 0.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">22</span><span class="o">-</span><span class="mi">672</span><span class="n">c58567d11</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="k">for</span> <span class="n">ScanY</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ScanYsize</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;line: &#39;</span><span class="p">,</span><span class="n">ScanY</span><span class="p">,</span><span class="s1">&#39; of &#39;</span><span class="p">,</span><span class="n">PixImageSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ProSize</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="k">for</span> <span class="n">ScanX</span>  <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ScanXsize</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>         <span class="n">Phi_trans</span> <span class="o">=</span> <span class="n">Probe</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>         <span class="k">for</span> <span class="n">NThickness</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NLevels</span> <span class="o">*</span> <span class="n">NLayers</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># NLevels depending of thickness</span>

<span class="ne">NameError</span>: name &#39;ScanYsize&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">DefPro2DK</span><span class="p">(</span><span class="n">ProPixelSize</span><span class="p">,</span> <span class="n">deltaZ</span><span class="p">,</span> <span class="n">NLayers</span><span class="p">,</span> <span class="n">wavl</span><span class="p">,</span> <span class="n">dk</span><span class="p">):</span>
    <span class="n">Projector2DK</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="mf">0.</span>  \
           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ProPixelSize</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ProPixelSize</span><span class="p">)]</span>  <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLayers</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

    <span class="n">tp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="o">-</span><span class="n">dk</span><span class="o">*</span><span class="n">ProPixelSize</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dk</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="n">dk</span><span class="o">*</span><span class="n">ProPixelSize</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dk</span><span class="o">*</span><span class="n">j</span><span class="p">]</span>  \
           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ProPixelSize</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ProPixelSize</span><span class="p">)])</span>
    <span class="n">tp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tp1</span><span class="p">)</span>     
    <span class="n">tp1</span> <span class="o">=</span> <span class="n">tp2</span> <span class="o">*</span> <span class="n">tp2</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLayers</span><span class="p">):</span>
        <span class="n">Projector2DK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="nb">complex</span><span class="p">)(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tp1</span><span class="o">*</span><span class="n">deltaZ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">wavl</span><span class="p">),</span>\
                            <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tp1</span><span class="o">*</span><span class="n">deltaZ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">wavl</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">tp1</span><span class="p">,</span> <span class="n">tp2</span>
    <span class="k">return</span> <span class="n">Projector2DK</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ProPixelSize</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">dk</span> <span class="o">=</span> <span class="mf">.1</span>
<span class="n">tp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="o">-</span><span class="n">dk</span><span class="o">*</span><span class="n">ProPixelSize</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dk</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="n">dk</span><span class="o">*</span><span class="n">ProPixelSize</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dk</span><span class="o">*</span><span class="n">j</span><span class="p">]</span>  \
           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ProPixelSize</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ProPixelSize</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tp1</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span>

<span class="n">tp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tp1</span><span class="p">)</span>  
<span class="nb">print</span><span class="p">(</span><span class="n">tp2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[-0.4 -0.3 -0.2 -0.1  0.   0.1  0.2  0.3]
 [-0.4 -0.3 -0.2 -0.1  0.   0.1  0.2  0.3]
 [-0.4 -0.3 -0.2 -0.1  0.   0.1  0.2  0.3]
 [-0.4 -0.3 -0.2 -0.1  0.   0.1  0.2  0.3]
 [-0.4 -0.3 -0.2 -0.1  0.   0.1  0.2  0.3]
 [-0.4 -0.3 -0.2 -0.1  0.   0.1  0.2  0.3]
 [-0.4 -0.3 -0.2 -0.1  0.   0.1  0.2  0.3]
 [-0.4 -0.3 -0.2 -0.1  0.   0.1  0.2  0.3]]
[[0.56568542 0.5        0.4472136  0.41231056 0.4        0.41231056
  0.4472136  0.5       ]
 [0.5        0.42426407 0.36055513 0.31622777 0.3        0.31622777
  0.36055513 0.42426407]
 [0.4472136  0.36055513 0.28284271 0.2236068  0.2        0.2236068
  0.28284271 0.36055513]
 [0.41231056 0.31622777 0.2236068  0.14142136 0.1        0.14142136
  0.2236068  0.31622777]
 [0.4        0.3        0.2        0.1        0.         0.1
  0.2        0.3       ]
 [0.41231056 0.31622777 0.2236068  0.14142136 0.1        0.14142136
  0.2236068  0.31622777]
 [0.4472136  0.36055513 0.28284271 0.2236068  0.2        0.2236068
  0.28284271 0.36055513]
 [0.5        0.42426407 0.36055513 0.31622777 0.3        0.31622777
  0.36055513 0.42426407]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">SimClick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;Sim&#39;</span><span class="p">]</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">ctags</span>

        <span class="n">MatLattice</span> <span class="o">=</span> <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;JCI&#39;</span><span class="p">][</span><span class="s1">&#39;MatLattice&#39;</span><span class="p">]</span>
        <span class="n">CoordinatesList</span> <span class="o">=</span> <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;JCI&#39;</span><span class="p">][</span><span class="s1">&#39;CoordinatesList&#39;</span><span class="p">]</span>
        <span class="n">Layers</span> <span class="o">=</span> <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;JCI&#39;</span><span class="p">][</span><span class="s1">&#39;Layers&#39;</span><span class="p">]</span>
        <span class="n">AtomsZLay</span> <span class="o">=</span> <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;JCI&#39;</span><span class="p">][</span><span class="s1">&#39;AtomsZLay&#39;</span><span class="p">]</span>
        <span class="n">NLayers</span> <span class="o">=</span> <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;JCI&#39;</span><span class="p">][</span><span class="s1">&#39;NLayers&#39;</span><span class="p">]</span>

        
        
        <span class="n">today</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M&quot;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Loading the experiment, checking variable sanity &amp; assigning default values</span>
        <span class="c1">#OnlyCheck, OnlyProbe, Channeling  = sanitycalculations()</span>
        <span class="n">OnlyCheck</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;OnlyCheck&#39;</span><span class="p">]</span>
        <span class="n">OnlyProbe</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;OnlyProbe&#39;</span><span class="p">]</span>
        <span class="n">Channeling</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;Channeling&#39;</span><span class="p">]</span>


        <span class="c1">#ApAngle, Detectors, DetShift, V0, aberrations, OAM_value = sanityoptics()</span>
        <span class="n">ApAngle</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;ApAngle&#39;</span><span class="p">]</span>
        <span class="n">Detectors</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;Detectors&#39;</span><span class="p">]</span>
        <span class="n">DetShift</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;DetShift&#39;</span><span class="p">]</span>
        <span class="n">V0</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;V0&#39;</span><span class="p">]</span>
        <span class="n">aberrations</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;aberrations&#39;</span><span class="p">]</span>
        <span class="n">OAM_value</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;OAM_value&#39;</span><span class="p">]</span>

        <span class="c1"># Aberrations:</span>
        <span class="n">ab</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;Aberrations&#39;</span><span class="p">]</span>
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C10&#39;</span><span class="p">]</span>  <span class="c1">#,&quot;\tDefocus in nm.&quot;)</span>
        
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C12a&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[3]#,&quot;\t2-fold astigmatism a direction in nm.&quot;)     </span>
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C12b&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[4]#,&quot;\t2-fold astigmatism b direction in nm.&quot;)</span>
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C21a&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[5]#,&quot;\tComma a direction in nm.&quot;)</span>
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C21b&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[6]#,&quot;\tComma b direction in nm.&quot;)</span>
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C23a&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[7]#,&quot;\t3-fold astigmatism a direction in nm.&quot;)</span>
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C23b&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[8]#,&quot;\t3-fold astigmatism b direction in nm.&quot;)</span>
        
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C30&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[9]#,&quot;\tThird order aberration (C_s) in nm.&quot;)</span>
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C32a&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[10]</span>
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C32b&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[11]</span>
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C34a&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[12]</span>
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C34b&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[13]</span>
        
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C41a&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[14]#,&quot;\tFourth order aberration in nm.&quot;)</span>
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C43a&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[15]</span>
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C45a&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[16]</span>
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C50&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[17]#/1000000,&quot;\tFifth order aberration in mm.&quot;)</span>
        <span class="n">aberrations</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab</span><span class="p">[</span><span class="s1">&#39;C70&#39;</span><span class="p">]</span> <span class="c1">#= aberrations[18]#/1000000,&quot;\tSeventh order aberration in mm.&quot;)</span>
        
                
        <span class="c1">#FieldofView, ImgPixelsX, ImgPixelsY, Thickness	= sanityimaging()</span>
        <span class="n">FieldofView</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FieldofView&#39;</span><span class="p">]</span>
        <span class="n">ImgPixelsX</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;ImgPixelsX&#39;</span><span class="p">]</span>
        <span class="n">ImgPixelsY</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;ImgPixelsY&#39;</span><span class="p">]</span>
        <span class="n">Thickness</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;Thickness&#39;</span><span class="p">]</span>
        
        <span class="c1">#PlotAmpProbe, PlotAngProbe, SaveCell, SaveChaProbe, SavePot, PlotSTEM = sanityoutput()</span>
        <span class="n">PlotAmpProbe</span> <span class="o">=</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;PlotAmpProbe&#39;</span><span class="p">]</span>
        <span class="n">PlotAngProbe</span> <span class="o">=</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;PlotAngProbe&#39;</span><span class="p">]</span>
        <span class="n">SaveCell</span> <span class="o">=</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;SaveCell&#39;</span><span class="p">]</span>
        <span class="n">SaveChaProbe</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;SaveChaProbe&#39;</span><span class="p">]</span>
        <span class="n">SavePot</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;SavePot&#39;</span><span class="p">]</span>
        <span class="n">PlotSTEM</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;PlotSTEM&#39;</span><span class="p">]</span>
        
        <span class="c1">#nmax, MaxOAM, Maxradius, ProPixelSize, PosProbChan, TransVect = sanitymisc()</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;nmax&#39;</span><span class="p">]</span>
        <span class="n">MaxOAM</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;MaxOAM&#39;</span><span class="p">]</span>
        <span class="n">Maxradius</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;Maxradius&#39;</span><span class="p">]</span>
        <span class="n">ProPixelSize</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;ProPixelSize&#39;</span><span class="p">]</span>
        <span class="n">PosProbChan</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;PosProbChan&#39;</span><span class="p">]</span>
        <span class="n">TransVect</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;TransVect&#39;</span><span class="p">]</span>
        
        <span class="n">deltaZ</span> <span class="o">=</span> <span class="n">DefdeltaZ</span><span class="p">(</span><span class="n">Layers</span><span class="p">,</span> <span class="n">MatLattice</span><span class="p">)</span> <span class="c1"># Difference in z between layers</span>

        <span class="c1"># Calculating the number of levels (i.e. how many times the unit cell repeats in Z)</span>
        <span class="n">NLevels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Thickness</span><span class="o">/</span><span class="n">MatLattice</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">NLevels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">NLevels</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Defining the variables for the imaging probe: dx, dk, kmax, xmax, dtheta, theta_max</span>
        <span class="n">theta_max</span> <span class="o">=</span> <span class="mi">250</span>

        <span class="c1"># Antialiasing </span>
        <span class="n">theta_max</span> <span class="o">=</span> <span class="n">theta_max</span> <span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span>
        <span class="c1"># Defining the wavelength </span>
        <span class="n">wavl</span> <span class="o">=</span> <span class="n">lamb</span><span class="p">(</span><span class="n">V0</span><span class="p">)</span>
        <span class="c1"># Some image variables</span>
        <span class="n">kmax</span> <span class="o">=</span> <span class="n">theta_max</span><span class="o">/</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">wavl</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kmax</span><span class="p">)</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">ProPixelSize</span> <span class="o">*</span> <span class="n">dx</span>
        <span class="n">dk</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span> <span class="n">xmax</span>
        <span class="n">dtheta</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">dk</span> <span class="o">*</span> <span class="n">wavl</span>

        <span class="n">printout</span><span class="p">(</span><span class="n">today</span><span class="p">,</span> <span class="n">OnlyCheck</span><span class="p">,</span> <span class="n">OnlyProbe</span><span class="p">,</span> <span class="n">Channeling</span><span class="p">,</span> <span class="n">ApAngle</span><span class="p">,</span> <span class="n">Detectors</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span> <span class="n">aberrations</span><span class="p">,</span> <span class="n">OAM_value</span><span class="p">,</span>\
                <span class="n">MatLattice</span><span class="p">,</span> <span class="n">CoordinatesList</span><span class="p">,</span> <span class="n">AtomsZLay</span><span class="p">,</span> <span class="n">deltaZ</span><span class="p">,</span> <span class="n">NLevels</span><span class="p">,</span> <span class="n">Thickness</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dk</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span>\
                <span class="n">FieldofView</span><span class="p">,</span> <span class="n">ImgPixelsX</span><span class="p">,</span> <span class="n">ImgPixelsY</span><span class="p">,</span> <span class="n">ProPixelSize</span><span class="p">)</span>
        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;FieldofView&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">FieldofView</span>
        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;ImgPixelsX&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ImgPixelsX</span>
        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;ImgPixelsY&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ImgPixelsY</span>
        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dx</span>
        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;dk&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dk</span>
        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;dtheta&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dtheta</span>
        

        <span class="k">if</span> <span class="n">OnlyCheck</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Calculation(s) start now:&quot;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="p">()</span>

            <span class="n">mask_antialising</span> <span class="o">=</span> <span class="n">createmask</span><span class="p">(</span><span class="n">dtheta</span><span class="p">,</span> <span class="n">ProPixelSize</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">Detectors</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DetShift</span><span class="p">)</span>

            <span class="c1"># Generating the probe</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Calculating the electron probe...&quot;</span><span class="p">)</span>
            <span class="n">Probe</span> <span class="o">=</span> <span class="n">createprobe</span><span class="p">(</span><span class="n">wavl</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">ApAngle</span><span class="p">,</span> <span class="n">ProPixelSize</span><span class="p">,</span> <span class="n">aberrations</span><span class="p">,</span> <span class="n">OAM_value</span><span class="p">)</span>
            
            <span class="n">probe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">ProbeDialog</span><span class="o">.</span><span class="n">probe</span><span class="o">.</span><span class="n">calProbe</span><span class="p">()</span>
            <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;probe2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Probe</span>
            <span class="n">Probe</span> <span class="o">=</span> <span class="n">probe</span>
            
            <span class="c1">#Probe[mask_antialising] = 0. # Antialiasing the probe</span>
            <span class="n">tp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Probe</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">Probe</span><span class="p">))</span>
            <span class="n">Probe</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tp1</span><span class="p">)</span>
            <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;Probe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Probe</span>
            
            <span class="c1">#Generates a plot of the 2D electron probe intensity &amp; phase (PNG)</span>
            <span class="n">plotProbe</span><span class="p">(</span><span class="n">Probe</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">today</span><span class="p">,</span> <span class="n">OnlyProbe</span><span class="p">,</span> <span class="n">PlotAmpProbe</span><span class="p">,</span> <span class="n">PlotAngProbe</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">OnlyProbe</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>

                <span class="c1"># Defining maximum number of pixels for the potentials and the range of the potentials in nm</span>
                <span class="c1"># (xmin, xmax, ymin,ymax)</span>
                <span class="n">ImageRange</span><span class="p">,</span> <span class="n">PixImageSize</span> <span class="o">=</span> <span class="n">ImageRange_ImageSize</span><span class="p">(</span><span class="n">MatLattice</span><span class="p">,</span> <span class="n">ProPixelSize</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
                

                <span class="k">if</span> <span class="n">Channeling</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">PixImageSize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ProPixelSize</span><span class="p">,</span> <span class="n">ProPixelSize</span><span class="p">])</span>
                        <span class="n">tp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">PosProbChan</span><span class="p">,</span> <span class="n">MatLattice</span><span class="p">[:</span><span class="mi">2</span><span class="p">,:</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># Position probe in real space</span>
                        <span class="n">ImageRange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">dx</span> <span class="o">*</span> <span class="n">ProPixelSize</span><span class="o">/</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">tp1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">dx</span> <span class="o">*</span> <span class="n">ProPixelSize</span><span class="o">/</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">tp1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">])</span>

                <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Calculating the scattering potentials...&quot;</span><span class="p">)</span>
                <span class="c1"># Unit cell potential calculated taking into account atoms within up to &quot;nmax-1&quot; surrounding cells</span>
                <span class="c1"># default value is nmax = 2</span>
                <span class="n">UnitCellPot2D</span> <span class="o">=</span> <span class="n">DefUnitCellPot2D</span><span class="p">(</span><span class="n">CoordinatesList</span><span class="p">,</span> <span class="n">AtomsZLay</span><span class="p">,</span> <span class="n">NLayers</span><span class="p">,</span> <span class="n">MatLattice</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span>

                <span class="c1"># Calculating the total 2D potentials, transmission, and projector(k space) for each layer</span>
                <span class="n">Pot2DLayer</span> <span class="o">=</span> <span class="n">DefPot2DLayer</span><span class="p">(</span><span class="n">PixImageSize</span><span class="p">,</span> <span class="n">ImageRange</span><span class="p">,</span> <span class="n">NLayers</span><span class="p">,</span> <span class="n">MatLattice</span><span class="p">,</span> <span class="n">UnitCellPot2D</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
                <span class="n">Trans2D</span> <span class="o">=</span> <span class="n">DefTrans2D</span><span class="p">(</span><span class="n">PixImageSize</span><span class="p">,</span> <span class="n">NLayers</span><span class="p">,</span> <span class="n">Pot2DLayer</span><span class="p">,</span> <span class="n">sigma</span><span class="p">(</span><span class="n">V0</span><span class="p">))</span>
                <span class="n">Projector2DK</span> <span class="o">=</span> <span class="n">DefPro2DK</span><span class="p">(</span><span class="n">ProPixelSize</span><span class="p">,</span> <span class="n">deltaZ</span><span class="p">,</span> <span class="n">NLayers</span><span class="p">,</span> <span class="n">wavl</span><span class="p">,</span> <span class="n">dk</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLayers</span><span class="p">):</span> <span class="c1"># Masking the Projector2DK for antialising</span>
                        <span class="n">Projector2DK</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mask_antialising</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                        <span class="n">Projector2DK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">Projector2DK</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                <span class="c1"># Calculating the chaneling of the electron probe</span>
                <span class="k">if</span> <span class="n">Channeling</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Calculating the channeling of the e- probe through the sample.&quot;</span><span class="p">)</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">(This might take some time, so please be patient!)&quot;</span><span class="p">)</span>
                        <span class="n">ChanneledProbe</span> <span class="o">=</span> <span class="n">createchannelling</span><span class="p">(</span><span class="n">Probe</span><span class="p">,</span> <span class="n">Trans2D</span><span class="p">,</span> <span class="n">Projector2DK</span><span class="p">,</span> <span class="n">NLevels</span><span class="p">)</span>
                        <span class="n">saveChanneledProbe</span><span class="p">(</span><span class="n">ChanneledProbe</span><span class="p">,</span> <span class="n">today</span><span class="p">,</span> <span class="n">SaveChaProbe</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">OAM_value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Calculating the OAM of the e- probe.&quot;</span><span class="p">)</span>
                                <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">(This might take some time, so please be patient!)&quot;</span><span class="p">)</span>
                                <span class="n">ChanneledProbeOAMChar</span> <span class="o">=</span> <span class="n">oam_evaluator</span><span class="p">(</span><span class="n">ChanneledProbe</span><span class="p">,</span> <span class="n">MaxOAM</span><span class="p">,</span> <span class="n">Maxradius</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
                                <span class="n">saveProbeOAMChar</span><span class="p">(</span><span class="n">ChanneledProbeOAMChar</span><span class="p">,</span> <span class="n">today</span><span class="p">)</span>

                <span class="c1"># Calculating the STEM images with a multislice method</span>
                <span class="k">if</span> <span class="n">Channeling</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Calculating the STEM images...&quot;</span><span class="p">)</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">(This might take some time, so please be patient!)&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">dtheta</span><span class="p">)</span>

                        <span class="n">CellSTEMImage</span><span class="p">,</span><span class="n">ronchi</span> <span class="o">=</span> <span class="n">multisliceSTEM</span><span class="p">(</span><span class="n">Probe</span><span class="p">,</span> <span class="n">Trans2D</span><span class="p">,</span> <span class="n">Projector2DK</span><span class="p">,</span> <span class="n">Detectors</span><span class="p">,</span> <span class="n">PixImageSize</span><span class="p">,</span> <span class="n">NLevels</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">DetShift</span><span class="p">)</span>
                        
                        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;PixImageSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PixImageSize</span>
                        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;DetShift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DetShift</span>

                        <span class="c1"># Saves  the core STEM images in npy format</span>
                        <span class="n">saveCellSTEM</span><span class="p">(</span><span class="n">CellSTEMImage</span><span class="p">,</span> <span class="n">today</span><span class="p">,</span> <span class="n">SaveCell</span><span class="p">)</span>
                        <span class="c1"># Generating the STEM images as requested by the experiment</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Multislice calculation is over!&quot;</span><span class="p">)</span>
                        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Now pySTEM is generating the STEM images as requested by the experiment&quot;</span><span class="p">)</span>     
                        <span class="n">STEMImages</span> <span class="o">=</span> <span class="n">createSTEMImages</span><span class="p">(</span><span class="n">CellSTEMImage</span><span class="p">,</span> <span class="n">ImageRange</span><span class="p">,</span> <span class="n">PixImageSize</span><span class="p">,</span> <span class="n">FieldofView</span><span class="p">,</span> <span class="n">ImgPixelsX</span><span class="p">,</span>\
                                                        <span class="n">ImgPixelsY</span><span class="p">,</span> <span class="n">ProPixelSize</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">MatLattice</span><span class="p">,</span> <span class="n">TransVect</span><span class="p">)</span>
                        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;ScanXSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CellSTEMImage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;ScanYSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CellSTEMImage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;ImageRange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImageRange</span>
                        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;PixImageSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PixImageSize</span>
                        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;FieldofView&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FieldofView</span>
                        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;ImgPixelsX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImgPixelsX</span>
                        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;ImgPixelsY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImgPixelsY</span>
                        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;ProPixelSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ProPixelSize</span>
                        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span>
                        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;MatLattice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MatLattice</span>
                        <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;TransVect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TransVect</span>
                        
                        <span class="c1"># Saving the STEM images in tiff</span>
                <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;STEM Images&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;Ronchis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ronchi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">STEMImages</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;STEM Images&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">STEMImages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;outimage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">STEMImages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">STEMImages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                
                <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;pixel_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;FieldofView&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">ctags</span><span class="p">[</span><span class="s1">&#39;ImgPixelsX&#39;</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">plotImage</span><span class="p">()</span>
                <span class="n">saveSTEM</span><span class="p">(</span><span class="n">STEMImages</span><span class="p">,</span> <span class="n">today</span><span class="p">,</span> <span class="n">PlotSTEM</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span> <span class="p">()</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;pySTEM is done with the calculation(s).&quot;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;This experiment took:&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span><span class="s2">&quot;seconds.&quot;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Thank you for using pySTEM.  Have a wonderful day!&quot;</span><span class="p">)</span>
        <span class="nb">print</span> 
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Imaging"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Gerd Duscher UTK/IAMM<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>
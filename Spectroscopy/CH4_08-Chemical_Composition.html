

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>3.5. Chemical Composition in Core-Loss Spectra &#8212; Introduction to Transmisison Electron Microscopy</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Spectroscopy/CH4_08-Chemical_Composition';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3.6. Analysis of Core-Loss Spectra" href="CH4_09-Analyse_Core_Loss.html" />
    <link rel="prev" title="3.4. Introduction to Core-Loss Spectroscopy" href="CH4_07-Introduction_Core_Loss.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Introduction to Transmisison Electron Microscopy - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Introduction to Transmisison Electron Microscopy - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Foreword (ReadME)
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Introduction/CH1_00-Introduction.html">1. Chapter 1: Introduction</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/CH1_01-Introduction_Python.html">1.1. Introduction to Python as it is used in this lecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/CH1_02-Prerequisites.html">1.2. Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/CH1_03-Data_Representation.html">1.3. Matplotlib and Numpy for Micrographs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/CH1_04-Open_File.html">1.4. Open DM3 Images, Spectra, Spectrum-Images and  Image-Stacks with pyNSID</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/CH1_05-Course_Organization.html">1.5. Course Organization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/CH1_06-Overview.html">1.6. Overview Notebook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/install_conda.html">1.7. Installation on your own computer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/computer_resources.html">1.8. Setting up computing resources</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Imaging/CH3_00-Imaging.html">2. Chapter 3: Imaging</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Imaging/CH3_01-Resolution.html">2.2. Resolution Limit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Imaging/CH3_03-CTF.html">2.3. Contrast Transfer Function</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Imaging/CH3_04-Linear_Image_Approximation.html">2.4. Linear Image Approximation: Weak Phase Object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Imaging/CH3_05-Defocus_Thickness.html">2.5. Defocus-Thickness Map with Multislice Algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Imaging/CH3_06-Image_Processing.html">2.6. Image Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Imaging/CH3_07-Image_Analysis.html">2.7. Image Analysis</a></li>

<li class="toctree-l2"><a class="reference internal" href="../Imaging/CH3_08-Thermal_Diffuse_Scattering.html">2.9. Thermal-Diffuse Scattering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Imaging/CH3_09-Z_Contrast.html">2.10. Z-Contrast Imaging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Imaging/CH3_10-Ronchigram.html">2.11. Ronchigram</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="CH4_00-Spectroscopy.html">3. Chapter 4: Spectroscopy</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="CH4_01-Introduction.html">3.1. Introduction to  Electron Energy-Loss Spectroscopy</a></li>
<li class="toctree-l2"><a class="reference internal" href="CH4_02-Fit_Zero_Loss.html">3.2. Fit of Zero-Loss Peak</a></li>
<li class="toctree-l2"><a class="reference internal" href="CH4_03-Drude.html">3.3. Analysing Low-Loss Spectra with Drude Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="CH4_07-Introduction_Core_Loss.html">3.4. Introduction to Core-Loss Spectroscopy</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">3.5. Chemical Composition in Core-Loss Spectra</a></li>
<li class="toctree-l2"><a class="reference internal" href="CH4_09-Analyse_Core_Loss.html">3.6. Analysis of Core-Loss Spectra</a></li>
<li class="toctree-l2"><a class="reference internal" href="CH4_10-ELNES.html">3.7. Energy-Loss Near-Edge Structure</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Homework/homework.html">4. Homework</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Homework/Homework01.html">4.1. Homework 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Homework/Homework02.html">4.2. Homework 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Homework/Homework03.html">4.3. Homework 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Homework/Homework04.html">4.4. Homework 4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Homework/Homework05-CBED.html">4.5. HW5:  Analyzing CBED Pattern</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Homework/Homework06-TwoBeam.html">4.6. HW6:  Analyzing CBED Pattern in Two Beam Condition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Homework/Homework07-Dynamic_CBED.html">4.7. HW7:  Simulating CBED Pattern</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/gduscher/MSE672-Introduction-to-TEM/main?urlpath=tree/docs/Spectroscopy/CH4_08-Chemical_Composition.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/gduscher/MSE672-Introduction-to-TEM" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/gduscher/MSE672-Introduction-to-TEM/issues/new?title=Issue%20on%20page%20%2FSpectroscopy/CH4_08-Chemical_Composition.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/Spectroscopy/CH4_08-Chemical_Composition.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Chemical Composition in Core-Loss Spectra</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#content">3.5.1. Content</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-important-packages">3.5.2. Load important packages</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-installed-packages">3.5.2.1. Check Installed Packages</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-all-relevant-libraries">3.5.2.2. Import all relevant libraries</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chemical-composition">3.5.3. Chemical Composition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background-fitting">3.5.3.1. Background Fitting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background-fitting-spatial-difference">3.5.3.2. Background Fitting: Spatial Difference</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background-subtraction-errors">3.5.3.3. Background Subtraction Errors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-section">3.5.3.4. Cross-Section</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculation-of-the-cross-section">3.5.3.5. Calculation of the Cross–Section</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">3.5.3.6. Summary</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-and-plot-a-spectrum">3.5.4. Load and plot a spectrum</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#which-elements-are-present">3.5.4.1. Which elements are present</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#probability-scale-of-y-axis">3.5.4.2. Probability scale of y-axis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#intensity-to-probability-calibration">3.5.4.3. Intensity to Probability Calibration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#components-of-a-core-loss-spectrum">3.5.5. Components of a core loss spectrum</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-of-cross-sections-and-spectrum">3.5.5.1. Plotting of cross sections and spectrum</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background">3.5.5.2. Background</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-a-spectrum">3.5.6. Fitting a Spectrum</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-the-fitting-mask">3.5.6.1. Preparing the fitting mask</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-fit">3.5.6.2. The Fit</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-of-the-fit">3.5.6.3. Plotting of the fit</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">3.5.7. Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#navigation">3.5.8. Navigation</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><font size = "5"> <strong>Chapter 4: <a class="reference internal" href="CH4_00-Spectroscopy.html"><span class="doc std std-doc">Spectroscopy</span></a></strong> </font></p>
<hr style="height:1px;border-top:4px solid #FF8200" />
<section class="tex2jax_ignore mathjax_ignore" id="chemical-composition-in-core-loss-spectra">
<h1><span class="section-number">3.5. </span>Chemical Composition in Core-Loss Spectra<a class="headerlink" href="#chemical-composition-in-core-loss-spectra" title="Permalink to this heading">#</a></h1>
<p><a class="reference external" href="https://raw.githubusercontent.com/gduscher/MSE672-Introduction-to-TEM/main/Spectroscopy/CH4_08-Chemical_Compostion.ipynb">Download</a></p>
<p>part of</p>
<p><font size = "5"> <strong><a class="reference internal" href="../_MSE672_Intro_TEM.html"><span class="doc std std-doc">MSE672:  Introduction to Transmission Electron Microscopy</span></a></strong></font></p>
<p>by Gerd Duscher, Spring 2023</p>
<p>Microscopy Facilities<br>
Institute of Advanced Materials &amp; Manufacturing<br>
Materials Science &amp; Engineering<br>
The University of Tennessee, Knoxville</p>
<p>Background and methods to analysis and quantification of data acquired with transmission electron microscopes.</p>
<section id="content">
<h2><span class="section-number">3.5.1. </span>Content<a class="headerlink" href="#content" title="Permalink to this heading">#</a></h2>
<p>Quantitative determination of composition in a core-loss EELS spectrum</p>
<p>Please cite:</p>
<p><a class="reference external" href="https://doi.org/10.1016/j.ultramic.2018.10.009">M. Tian et  al. <em>Measuring the areal density of nanomaterials by electron energy-loss spectroscopy</em>
Ultramicroscopy Volume 196, 2019, pages 154-160</a></p>
<p>as a reference of the here introduced model-based quantification method.</p>
</section>
<section id="load-important-packages">
<h2><span class="section-number">3.5.2. </span>Load important packages<a class="headerlink" href="#load-important-packages" title="Permalink to this heading">#</a></h2>
<section id="check-installed-packages">
<h3><span class="section-number">3.5.2.1. </span>Check Installed Packages<a class="headerlink" href="#check-installed-packages" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">get_distribution</span><span class="p">,</span> <span class="n">DistributionNotFound</span>

<span class="k">def</span> <span class="nf">test_package</span><span class="p">(</span><span class="n">package_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test if package exists and returns version or -1&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">get_distribution</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span><span class="o">.</span><span class="n">version</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">DistributionNotFound</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;-1&#39;</span>
    <span class="k">return</span> <span class="n">version</span>

<span class="k">if</span> <span class="n">test_package</span><span class="p">(</span><span class="s1">&#39;pyTEMlib&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="s1">&#39;0.2023.4.0&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;installing pyTEMlib&#39;</span><span class="p">)</span>
    <span class="o">!{</span>sys.executable<span class="o">}</span><span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w">  </span>--upgrade<span class="w"> </span>pyTEMlib<span class="w"> </span>-q
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="import-all-relevant-libraries">
<h3><span class="section-number">3.5.2.2. </span>Import all relevant libraries<a class="headerlink" href="#import-all-relevant-libraries" title="Permalink to this heading">#</a></h3>
<p>Please note that the EELS_tools package from pyTEMlib is essential.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> ipympl
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;../../pyTEMlib/&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1">## import the configuration files of pyTEMlib (we need access to the data folder)</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="kn">import</span> <span class="nn">pyTEMlib</span>
<span class="c1">#import pyTEMlib.viz as plot</span>
<span class="kn">import</span> <span class="nn">pyTEMlib.file_tools</span> <span class="k">as</span> <span class="nn">ft</span>
<span class="kn">import</span> <span class="nn">pyTEMlib.eels_tools</span> <span class="k">as</span> <span class="nn">eels</span>
<span class="kn">import</span> <span class="nn">pyTEMlib.interactive_eels</span> <span class="k">as</span> <span class="nn">ieels</span>

<span class="kn">import</span> <span class="nn">advanced_eels_tools</span> <span class="k">as</span> <span class="nn">aeels</span>

<span class="kn">from</span> <span class="nn">matplotlib.widgets</span> <span class="kn">import</span> <span class="n">Cursor</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
<span class="kn">from</span> <span class="nn">matplotlib.widgets</span> <span class="kn">import</span> <span class="n">SpanSelector</span>

<span class="kn">from</span> <span class="nn">scipy.ndimage.filters</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>

<span class="c1"># For archiving reasons it is a good idea to print the version numbers out at this point</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pyTEM version: &#39;</span><span class="p">,</span><span class="n">pyTEMlib</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>You don&#39;t have igor installed.     If you wish to open igor files, you will need to install it     (pip install igor) before attempting.
You don&#39;t have gwyfile installed.     If you wish to open .gwy files, you will need to      install it (pip install gwyfile) before attempting.
Symmetry functions of spglib enabled
advanced EELS features enabled
pyTEM version:  0.2023.5.0
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="chemical-composition">
<h2><span class="section-number">3.5.3. </span>Chemical Composition<a class="headerlink" href="#chemical-composition" title="Permalink to this heading">#</a></h2>
<p>We discuss first the conventional method of EELS chemical compoisition determination</p>
<p>In this chapter we use the area under the ionization edge to determine the chemical composition of a (small) sample volume.
The equation used to determine the number of atoms per unit volume <span class="math notranslate nohighlight">\(N\)</span> (also called areal density) is:
\begin{equation}
I_{edge}(\beta, \Delta E) = N * I_{0}(\beta) * \sigma_{edge}(\beta, \Delta E)
\end{equation}</p>
<p><span class="math notranslate nohighlight">\(I_0\)</span> is the number of electrons hitting the sample, and so directly comparable to the beam current.</p>
<p>The equation can be approximated assuming that the spectrum has not been corrected for single scattering:
\begin{equation}
I_{edge}(\beta, \Delta E) = N * I_{low-loss}(\beta,\Delta E) *  \sigma_{edge}(\beta, \Delta E)
\end{equation}
where <span class="math notranslate nohighlight">\(\beta\)</span> is the collection angle and <span class="math notranslate nohighlight">\(\sigma_{edge}\)</span> is the <strong>partial</strong> cross–section (for energy window <span class="math notranslate nohighlight">\(\Delta E\)</span>) for the core–loss excitation.</p>
<p>The integration interval <span class="math notranslate nohighlight">\(\Delta E\)</span> which defines  <span class="math notranslate nohighlight">\(I_{edge}(\beta, \Delta E)\)</span> and <span class="math notranslate nohighlight">\(I_{low-loss}\)</span> is shown in figure below.</p>
<img title="chemical_composition" width="50%" alt="chemical_composition" src="images/edge2.jpg">
<p><em>Valence–loss, core–loss edges and background of SrTiO<span class="math notranslate nohighlight">\(_3\)</span>]{\label{fig:edge2} Ti-L<span class="math notranslate nohighlight">\(_{2,3}\)</span> and O-K (right) core–loss edges and background of SrTiO<span class="math notranslate nohighlight">\(_3\)</span>. The valence-loss spectrum with the zero–loss <span class="math notranslate nohighlight">\(I_{zero-loss}\)</span> and low–loss intensities <span class="math notranslate nohighlight">\(I_{low-loss} \)</span> to be used in the quantification are displayed in the background.</em></p>
<p>If we cannot determine the intensity of the zero-loss peak  <span class="math notranslate nohighlight">\(I_{zero-loss}\)</span>  or of the low-loss area <span class="math notranslate nohighlight">\(I_{low-loss}\)</span>, we still can determine relative chemical compositions of two elements <span class="math notranslate nohighlight">\(a\)</span> and <span class="math notranslate nohighlight">\(b\)</span> considering that:</p>
<p>\begin{equation}
\frac{N_a}{N_b} = \frac{I_{e_a}(\beta, \Delta E)}{I_0 \sigma_{e_a}(\beta, \Delta E)} \frac{I_0 \sigma_{e_b}(\beta, \Delta E) } {I_{e_b}(\beta, \Delta E)} \nonumber
\end{equation}</p>
<p>\begin{equation}
\frac{N_a}{N_b}=  \frac{I_{e_a}(\beta, \Delta E)\sigma_{e_b}(\beta, \Delta E) }
{I_{e_b}(\beta, \Delta E)\sigma_{e_a}(\beta, \Delta E) }
\end{equation}</p>
<p>and the value <span class="math notranslate nohighlight">\(I_0\)</span> cancels out.</p>
<p>The integration windows for the two edges <span class="math notranslate nohighlight">\(\Delta E\)</span> should be the same, but can be chosen differently as long as we use a different cross-section <span class="math notranslate nohighlight">\(\sigma\)</span> as well. For that case we get:</p>
<p>\begin{equation} <br />
\frac{N_a}{N_b} =  \frac{I_{e_a}(\beta, \Delta E_a)\sigma_{e_b}(\beta, \Delta E_b) }
{I_{e_b}(\beta, \Delta E_a)\sigma_{e_a}(\beta, \Delta E_a) }
\end{equation}</p>
<p>Note, that the use of different integration windows usually results in a larger error of the quantification.</p>
<p>In order to use the above equation we first  have to determine the background under the edge.
This background  is then subtracted from the spectrum.
Then we integrate over the different parts of the spectrum to determine the integrals (sums) of <span class="math notranslate nohighlight">\(I_{edge}\)</span>,  and <span class="math notranslate nohighlight">\(I_{zero-loss}\)</span>, or  <span class="math notranslate nohighlight">\(I_{low-loss} \)</span> (depending whether we did a SSD first or not).
After that we have to determine the cross-section (<a class="reference internal" href="CH4_07-Introduction_Core_Loss.html"><span class="doc std std-doc">notebook</span></a>) for each edge for the parameter <span class="math notranslate nohighlight">\(\beta\)</span> and <span class="math notranslate nohighlight">\(\Delta E\)</span>.</p>
<section id="background-fitting">
<h3><span class="section-number">3.5.3.1. </span>Background Fitting<a class="headerlink" href="#background-fitting" title="Permalink to this heading">#</a></h3>
<p>The core-loss edges occur usually at energy-losses higher than 100 eV, superimposed to a monotonic decreasing background. For quantification of the chemical composition we need the area under the edge of a spectrum, and therefore, need to subtract the intensity of the background under the edge. Here we discuss several methods of how to determine the intensity of the background under the  edge.</p>
<p>The high energy <code class="docutils literal notranslate"><span class="pre">tail</span></code> of the plasmon peak follows the power law <span class="math notranslate nohighlight">\(A E^{-r}\)</span>. The parameter is varies widely and is associated with the intensity of the background. <span class="math notranslate nohighlight">\(E\)</span> is the energy loss. The exponent <span class="math notranslate nohighlight">\(r\)</span> gives the slope and should be between 2-6. The value <span class="math notranslate nohighlight">\(r\)</span> usually decreases with increasing specimen thickness, because of plural-scattering contributions. <span class="math notranslate nohighlight">\(r\)</span> also decreases with increasing collection angles <span class="math notranslate nohighlight">\(\beta\)</span>, but increases with increasing energy–loss.</p>
<p><strong>Consequently, we have to determine the parameters <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(r\)</span> for each ionization edge.</strong></p>
<p>The fitting of the power law <span class="math notranslate nohighlight">\(A E^{-r}\)</span> (to determine <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(r\)</span>) is usually done in an area just before the edge, assuming that the background follows the same power law under the edge.
This fit can only work if the detector dark current and gain variation is corrected prior to the analysis.</p>
<p>A standard technique is to match the pre–edge background <span class="math notranslate nohighlight">\(J(E)\)</span> to a function <span class="math notranslate nohighlight">\(F(E)\)</span> (here the power law) whose parameter (here <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(r\)</span>) minimize the quantity:
\begin{equation}
\chi^2 = \sum \limits_{i} \left[  \frac{J_i - F_i}{\sigma_i} \right]^2
\end{equation}
where <span class="math notranslate nohighlight">\(i\)</span> is the index of the channel within the fitting region and <span class="math notranslate nohighlight">\(\sigma_i\)</span> represents the statistical error (standard deviation) of the intensity in that channel.</p>
<p>The value <span class="math notranslate nohighlight">\(\sigma_i\)</span> is often considered constant (for example <span class="math notranslate nohighlight">\(1/3\)</span> or <span class="math notranslate nohighlight">\(e^{-1}\)</span>). For our problem, the quantum mechanical shot noise is adequate
\begin{equation}
\sigma_i = \ln(J_i - \sqrt{J_i}) - \ln(J_i) \approx \sqrt{J_i}
\end{equation}
where we assume that <span class="math notranslate nohighlight">\(J_i\)</span> is in number of electrons and not in counts (number of electrons times a conversion factor).</p>
<p>In the figure below, we see the result and the output of the background fit (plus subtraction).</p>
<img title="chemical_composition" width="50%" alt="chemical_composition" src="images/background.jpg">
<ul class="simple">
<li><p>Background fit on a spectrum of SrTiO<span class="math notranslate nohighlight">\(_3\)</span>]{\label{fig:background} Background fit on a spectrum of SrTiO<span class="math notranslate nohighlight">\(_3\)</span>. The <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(r\)</span> parameter together with the normalized (reduced) <span class="math notranslate nohighlight">\(\chi^2_n\)</span> parameter is displayed in the {\bf Results} window.*</p></li>
</ul>
</section>
<section id="background-fitting-spatial-difference">
<h3><span class="section-number">3.5.3.2. </span>Background Fitting: Spatial Difference<a class="headerlink" href="#background-fitting-spatial-difference" title="Permalink to this heading">#</a></h3>
<p>We can use also an experimentally determined background, if impurity or dopant atoms are present in confined areas only. Then,  we can take two spectra: one next to this area and one at this area. The near by area will result in a spectrum without this edge and can be used as a background for quantification of the other spectrum. This method is highly accurate if the sample thickness does not change between these areas. The measurement of ppm levels of dopants and impurity atoms can achieved with this method. This Method will be more closely examined in Section Spatial-Difference</p>
</section>
<section id="background-subtraction-errors">
<h3><span class="section-number">3.5.3.3. </span>Background Subtraction Errors<a class="headerlink" href="#background-subtraction-errors" title="Permalink to this heading">#</a></h3>
<p>In addition to possible systematic errors, any fitted background to noisy data will be subject to to a random or statistical error.  The signal noise ration (SNR) can be defined as:</p>
<p>\begin{equation}
SNR = I_{edge} [var(I_{edge})]^{-1/2} = I_{edge}/(I_{edge}+ h \quad I_{background})^{1/2}
\end{equation}</p>
<p>where the dimensionless parameter <span class="math notranslate nohighlight">\(h\)</span> represents the uncertainty of the background fit due to noise.
If the width of the integration window is sufficiently small (for example the same width as the fitting window) then this factor <span class="math notranslate nohighlight">\(h\)</span> is relatively small. For equal windows we can approximate <span class="math notranslate nohighlight">\(h = 10\)</span>.</p>
</section>
<section id="cross-section">
<h3><span class="section-number">3.5.3.4. </span>Cross-Section<a class="headerlink" href="#cross-section" title="Permalink to this heading">#</a></h3>
<p>The cross–section gives us the weight of the edge intensity to compare to different elements or to the total number of electrons (to compute areal density).
Such a cross–sections is compared to an edge intensity in the figure below.</p>
<img title="cross-section1" width="50%" alt="Comparison of calculated cross-section and Si-L edges" src="images/cross-section1.jpg">
<p><em>The shape of a calculated cross-section (black) is compared to the  intensity of a Si-L<span class="math notranslate nohighlight">\(_{2,3}\)</span> and Si-<span class="math notranslate nohighlight">\(L_{1}\)</span> edge after background subtraction (gray). The SSD–corrected spectrum (red) and the extrapolated background (light blue) are also shown. In the results window, we see the integrated edge intensity, the integrated cross-sections and the determined areal density.</em></p>
<p>There are different methods of how to use cross-sections in the quantification of  the chemical composition from spectra:</p>
<p>Egerton gives in his book a tabulated list of generalized oscillator strength (GOS) for different elements. The values for different integration windows <span class="math notranslate nohighlight">\(\Delta E\)</span> can be linearly extrapolated for other integration window widths. The GOS have to be extrapolated for the chosen integration window and converted to cross–sections. The GOS are calculated with the Bethe theory in Hydrogenic approximation (see below in chapter \ref{sec:cross-section-calculate}</p>
</section>
<section id="calculation-of-the-cross-section">
<h3><span class="section-number">3.5.3.5. </span>Calculation of the Cross–Section<a class="headerlink" href="#calculation-of-the-cross-section" title="Permalink to this heading">#</a></h3>
<p>There are two methods in  the literature to calculate the cross–section. One is the one where we assume s states in free atoms and is called Hydrogenic approximation and one which approximates  the free atoms a little more detailed: the Hatree-Slater method.</p>
<p>Both methods are based on free atom calculations, because of the strong bonding of the core–electrons to the nucleus, band-structure (collective) effects can be neglected.</p>
<p>The figure below compares the cross–sections of these two approximations (with a background added) to an experimental spectrum.</p>
<img title="cross-section1" width="50%" alt="The shape of a Hydrogenic and Hatree--Slater cross-section" src="images/cross-section-both.jpg">
<p><em>The shape of a Hydrogenic (green) and Hatree–Slater (blue) cross-section (with a background added) is compared to an experimental (SSD-corrected) spectrum of Si.</em></p>
</section>
<section id="summary">
<h3><span class="section-number">3.5.3.6. </span>Summary<a class="headerlink" href="#summary" title="Permalink to this heading">#</a></h3>
<p>The power law is not really correct for any larger energy interval, which results in a change of the <span class="math notranslate nohighlight">\(r\)</span> exponent throughout the spectrum’s energy range.</p>
<p>A polynomial of 2<span class="math notranslate nohighlight">\(^{nd}\)</span> order can be used to fit the spectrum, but often leads to strong oscillations in the extrapolated high energy part.</p>
<p>The exact slope of the extrapolated background depends on pre-edge features and noise</p>
<p><strong>Generally the above described classic method of quantification is often non-reproducible, and results in errors often in excess of 100%.</strong></p>
<p>In the following we will work with a model based method that reduces the artefacts, increases reproducibility and improves the error to about 3 atom % absolute.</p>
</section>
</section>
<section id="load-and-plot-a-spectrum">
<h2><span class="section-number">3.5.4. </span>Load and plot a spectrum<a class="headerlink" href="#load-and-plot-a-spectrum" title="Permalink to this heading">#</a></h2>
<p>As an example we load the spectrum <strong>1EELS Acquire (high-loss).dm3</strong> from the <em>example data</em> folder.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load file</span>
<span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;../example_data/1EELS Acquire (high-loss).dm3&#39;</span>

<span class="n">datasets</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="c1">#os.path.join(current_directory,filename))</span>

<span class="n">main_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="s1">&#39;Channel_000&#39;</span><span class="p">]</span>

<span class="k">if</span> <span class="n">main_dataset</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;SPECTRUM&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NOT what we want here&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">main_dataset</span><span class="o">.</span><span class="n">view_metadata</span><span class="p">()</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">main_dataset</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>experiment :
	single_exposure_time : 3.0
	exposure_time : 63.0
	number_of_frames : 21
	collection_angle : 33.0
	convergence_angle : 30.0
	acceleration_voltage : 200000.0
filename : ../example_data/1EELS Acquire (high-loss).dm3
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a30a9ac3167043388ab7814a7338f007", "version_major": 2, "version_minor": 0}</script></div>
</div>
<section id="which-elements-are-present">
<h3><span class="section-number">3.5.4.1. </span>Which elements are present<a class="headerlink" href="#which-elements-are-present" title="Permalink to this heading">#</a></h3>
<p>To determine which elements are present we add a cursor to the above plot (see <a class="reference internal" href="CH4_07-Introduction_Core_Loss.html"><span class="doc std std-doc">Working with Cross-Sections</span></a> for details) and with a left (right) mouse-click, we will get the major (all) edges in the vincinity of the cursor.</p>
<p>In the example we note that the N-K edge of this boron nitride sample is not at 400keV. We have to adjust the energy-scale. <br>(THIS SHOULD NOT HAPPEN IN NORMAL SPECTRA AND IS FOR DEMONSTRATION ONLY)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">maximal_chemical_shift</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">energy_scale</span> <span class="o">=</span> <span class="n">main_dataset</span><span class="o">.</span><span class="n">energy_loss</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">ieels</span><span class="o">.</span><span class="n">EdgesAtCursor</span><span class="p">(</span><span class="n">main_dataset</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">,</span> <span class="n">main_dataset</span><span class="p">,</span> <span class="n">maximal_chemical_shift</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aeels</span><span class="o">.</span><span class="n">find_edge_names</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;N -K1&#39;]
</pre></div>
</div>
</div>
</div>
<p>Let’s correct the energy scale of the example spectrum.</p>
<p>Again a shift of the enrrgy scale is normal but not a discripancy of the dispersion.</p>
</section>
<section id="probability-scale-of-y-axis">
<h3><span class="section-number">3.5.4.2. </span>Probability scale of y-axis<a class="headerlink" href="#probability-scale-of-y-axis" title="Permalink to this heading">#</a></h3>
<p>We need to know the total amount of electrons involved in the EELS spectrum</p>
<p>There are three possibilities:</p>
<ul class="simple">
<li><p>the intensity of the low loss will give us the counts per acquisition time</p></li>
<li><p>the intensity of the beam in an image</p></li>
<li><p>a direct measurement of the incident beam current</p></li>
</ul>
<p>Here we got the low-loss spectrum. For the example please load <strong>1EELS Acquire (low-loss).dm3</strong> from the <em>example data</em> folder.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ll_datasets</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="s1">&#39;../example_data/1EELS Acquire (low-loss).dm3&#39;</span><span class="p">)</span>
<span class="n">ll_dataset</span> <span class="o">=</span> <span class="n">ll_datasets</span><span class="p">[</span><span class="s1">&#39;Channel_000&#39;</span><span class="p">]</span>
<span class="n">ll_dataset</span><span class="o">.</span><span class="n">view_metadata</span><span class="p">()</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">ll_dataset</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>experiment :
	single_exposure_time : 0.01
	exposure_time : 63.0
	number_of_frames : 21
	collection_angle : 33.0
	convergence_angle : 30.0
	acceleration_voltage : 200000.0
filename : ../example_data/1EELS Acquire (low-loss).dm3
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "0cd583f9e152476b834ceb3d3555f60e", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
<section id="intensity-to-probability-calibration">
<h3><span class="section-number">3.5.4.3. </span>Intensity to Probability Calibration<a class="headerlink" href="#intensity-to-probability-calibration" title="Permalink to this heading">#</a></h3>
<p>We need to calibrate the number of counts with the integration time of the spectrum.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ll_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">][</span><span class="s1">&#39;exposure_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ll_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">][</span><span class="s1">&#39;number_of_frames&#39;</span><span class="p">]</span> <span class="o">*</span><span class="n">ll_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">][</span><span class="s1">&#39;single_exposure_time&#39;</span><span class="p">]</span>
<span class="n">I0</span> <span class="o">=</span> <span class="n">ll_dataset</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">ll_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">][</span><span class="s1">&#39;exposure_time&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">main_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">][</span><span class="s1">&#39;exposure_time&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;incident beam current of core--loss spectrum is </span><span class="si">{</span><span class="n">I0</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> counts  in  </span><span class="si">{</span><span class="n">ll_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">][</span><span class="s1">&#39;exposure_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> sec&quot;</span><span class="p">)</span>

<span class="n">main_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">][</span><span class="s1">&#39;intentsity_scale_ppm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">I0</span><span class="o">*</span><span class="mf">1e6</span>
<span class="n">main_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">][</span><span class="s1">&#39;incident_beam_current_counts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">I0</span>

<span class="n">dispersion</span> <span class="o">=</span> <span class="n">main_dataset</span><span class="o">.</span><span class="n">energy_loss</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">main_dataset</span><span class="o">.</span><span class="n">energy_loss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">spectrum</span> <span class="o">=</span> <span class="n">main_dataset</span> <span class="o">*</span><span class="n">main_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">][</span><span class="s1">&#39;intentsity_scale_ppm&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">dispersion</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="s1">&#39;inelastic scattering probability&#39;</span>
<span class="n">spectrum</span><span class="o">.</span> <span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;ppm&#39;</span>
<span class="n">view</span> <span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>incident beam current of core--loss spectrum is 34710045600 counts  in  0.21 sec
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9dd9ba654dd945da8c65dc999db4447e", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">energy_loss</span><span class="p">,</span> <span class="p">[</span><span class="mi">188</span><span class="p">,</span> <span class="mi">388</span><span class="p">])</span>
<span class="n">dE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">401</span><span class="o">-</span><span class="mi">188</span><span class="p">)</span><span class="o">/</span> <span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">dE</span> <span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energy_loss</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energy_loss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0.26625, 0.25)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum</span><span class="o">.</span><span class="n">energy_loss</span> <span class="o">*=</span> <span class="n">dE</span><span class="o">/</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">energy_loss</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energy_loss</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum</span><span class="o">.</span><span class="n">energy_loss</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>200.22
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum</span><span class="o">.</span><span class="n">energy_loss</span> <span class="o">-=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energy_loss</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-</span><span class="mi">188</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">main_dataset</span><span class="o">.</span><span class="n">title</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d02c3f63b0da44bab564b040404e278b", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
</section>
<section id="components-of-a-core-loss-spectrum">
<h2><span class="section-number">3.5.5. </span>Components of a core loss spectrum<a class="headerlink" href="#components-of-a-core-loss-spectrum" title="Permalink to this heading">#</a></h2>
<p>-background</p>
<p>-absorption edges</p>
<section id="plotting-of-cross-sections-and-spectrum">
<h3><span class="section-number">3.5.5.1. </span>Plotting of cross sections and spectrum<a class="headerlink" href="#plotting-of-cross-sections-and-spectrum" title="Permalink to this heading">#</a></h3>
<p>please note that spectrum and cross sections are not on the same scale</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">energy_scale</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energy_loss</span>
<span class="n">B_Xsection</span> <span class="o">=</span> <span class="n">eels</span><span class="o">.</span><span class="n">xsec_xrpa</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">10.</span> <span class="p">)</span><span class="o">/</span><span class="mf">1e10</span>  
<span class="n">N_Xsection</span> <span class="o">=</span> <span class="n">eels</span><span class="o">.</span><span class="n">xsec_xrpa</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">10.</span> <span class="p">,</span><span class="n">shift</span><span class="o">=-</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="mf">1e10</span>       <span class="c1">#  xsec  is in barns = 10^28 m2 = 10^10 nm2</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">B_Xsection</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;B X-section&#39;</span> <span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">N_Xsection</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;N X-section&#39;</span> <span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;energy_loss [eV]&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;probability [atoms/nm$^</span><span class="si">{2}</span><span class="s1">$]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;spectrum&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;probability [ppm]&#39;</span><span class="p">)</span>
<span class="c1">#plt.xlim(100,500)</span>
<span class="c1">#plt.legend();</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a42a4d59cd764ac1a65c7a9b6ed166c3", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
<section id="background">
<h3><span class="section-number">3.5.5.2. </span>Background<a class="headerlink" href="#background" title="Permalink to this heading">#</a></h3>
<p>The other ingredient in a core loss spectrum is the background</p>
<p>The backgrund consists of</p>
<ul class="simple">
<li><p>ionization edges to the left of the beginning of the spectrum (offset)</p></li>
<li><p>tail of the plasmon peak (generally a power_law with <span class="math notranslate nohighlight">\(\approx A* E^{-3}\)</span>)</p></li>
</ul>
<p>Here we approximate the background in an energy window before the first ionization edge in the spectrum as a power law with exponent <span class="math notranslate nohighlight">\(r\approx 3\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">leastsq</span>  <span class="c1">## leastsqure fitting routine fo scipy</span>


<span class="c1"># Determine energy window in pixels</span>
<span class="n">bgdStart</span> <span class="o">=</span> <span class="mi">130</span>
<span class="n">bgdWidth</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">energy_scale</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energy_loss</span>
<span class="n">offset</span> <span class="o">=</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">dispersion</span> <span class="o">=</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">startx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">bgdStart</span><span class="o">-</span><span class="n">offset</span><span class="p">)</span><span class="o">/</span><span class="n">dispersion</span><span class="p">)</span>
<span class="n">endx</span> <span class="o">=</span> <span class="n">startx</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">bgdWidth</span><span class="o">/</span><span class="n">dispersion</span><span class="p">)</span> 

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">[</span><span class="n">startx</span><span class="p">:</span><span class="n">endx</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="n">startx</span><span class="p">:</span><span class="n">endx</span><span class="p">])</span>

<span class="c1"># Initial values of parameters</span>
<span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0E+20</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>

<span class="c1">## background fitting </span>
<span class="k">def</span> <span class="nf">bgdfit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">err</span>
<span class="n">p</span><span class="p">,</span> <span class="n">lsq</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span><span class="n">bgdfit</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Power-law background with amplitude A: </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> and exponent -r: </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">#Calculate background over the whole energy scale</span>
<span class="n">background</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,(</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">energy_loss</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;spectrum&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">energy_loss</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;background&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;energy-loss (eV)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;scattering probability (ppm)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Power-Law Background&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Power-law background with amplitude A: 1569531.4 and exponent -r: 3.10
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ef8c1c3c323241439ea0501e9882d211", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
</section>
<section id="fitting-a-spectrum">
<h2><span class="section-number">3.5.6. </span>Fitting a Spectrum<a class="headerlink" href="#fitting-a-spectrum" title="Permalink to this heading">#</a></h2>
<p>We are revisiting the above the fundamental equation of the chemical composition:</p>
<p>We already calibrated the cross section in per <span class="math notranslate nohighlight">\(nm^2\)</span> and so if we start again from the fundamental equation:</p>
<p>\begin{equation}
I_{edge}(\beta, \Delta E) = N I_{0}(\beta) \sigma_{edge}(\beta, \Delta E)
\end{equation}</p>
<p>and as above we calibrate the intensity of the spectrum by <span class="math notranslate nohighlight">\(I_{spectrum}/I_0\)</span> then we get::</p>
<p>\begin{equation}
\frac{I_{edge}(\beta, \Delta E)}{I_0} = I^{norm}<em>{edge}  = N \sigma</em>{edge}(\beta, \Delta E)
\end{equation}</p>
<p>and if we fit the calibrated intensity with the cross section then we can replace<span class="math notranslate nohighlight">\(I^{norm}_{edge}\)</span> by a fitting value <span class="math notranslate nohighlight">\(q_{edge}\)</span> multiplied by cross section <span class="math notranslate nohighlight">\(\sigma\)</span>:</p>
<div class="math notranslate nohighlight">
\[
N =  \frac{I_{edge}(\beta, \Delta E)/I_0}{\sigma_{edge}(\beta, \Delta E)}  = \frac{I^{norm}_{edge}}{\sigma_{edge}(\beta, \Delta E)} = \frac{q_{edge} * \sigma_{edge}(\beta, \Delta E)}{\sigma_{edge}(\beta, \Delta E)} = q_{edge}
\]</div>
<p>and N is in atoms per nm<span class="math notranslate nohighlight">\(^2\)</span>.</p>
<p>So a fit to a callibrated spectrum as above, will get us a <code class="docutils literal notranslate"><span class="pre">fitting</span> <span class="pre">parameter</span></code> which is an <code class="docutils literal notranslate"><span class="pre">areal</span> <span class="pre">density</span></code> (which is a legitimate thermodynamic quantity).</p>
<p>And for the relative composition we get:
$<span class="math notranslate nohighlight">\(
\frac{N_a}{N_b}= \frac{q_a}{q_b}
\)</span>$</p>
<p>In the following we will do this kind of a fit by:</p>
<ul class="simple">
<li><p>calibrate the intensity in the spectrum (in ppm)</p></li>
<li><p>using  cross section in units of nm<span class="math notranslate nohighlight">\(^2\)</span></p></li>
</ul>
<blockquote>
<div><p>Please note that for the relative composition , the <span class="math notranslate nohighlight">\(I_0\)</span> will fall out and so a fit to a spectrum without calibrated intensity will still give the relative intensity accurately.</p>
</div></blockquote>
<section id="preparing-the-fitting-mask">
<h3><span class="section-number">3.5.6.1. </span>Preparing the fitting mask<a class="headerlink" href="#preparing-the-fitting-mask" title="Permalink to this heading">#</a></h3>
<p>Our theoretical cross sections do not include any solid state effects (band structure) and so the fine structure at the onset of the spectra must be omitted in a quantification.</p>
<p>These parts of the spectrum will be simply set to zero. We plot the masked spectrum that will be evaluated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">energy_scale</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energy_loss</span>

<span class="n">dispersion</span> <span class="o">=</span> <span class="p">(</span><span class="n">energy_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">offset</span> <span class="o">=</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">startx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">bgdStart</span><span class="o">-</span><span class="n">offset</span><span class="p">)</span><span class="o">/</span><span class="n">dispersion</span><span class="p">)</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">))</span>
<span class="n">mask</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">startx</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

<span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">edges</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">edges</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">5</span>
<span class="n">edges</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;K1&#39;</span>
<span class="n">edges</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">edges</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">7</span>
<span class="n">edges</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;K1&#39;</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">((</span><span class="n">eels</span><span class="o">.</span><span class="n">get_x_sections</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">]))[</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]])</span>
    <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">eels</span><span class="o">.</span><span class="n">get_x_sections</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">]))[</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span>
    <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;start_exclude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">5</span> 
    <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;end_exclude&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">50</span>
    <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eels</span><span class="o">.</span><span class="n">get_x_sections</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">])</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;start_exclude&#39;</span><span class="p">]):</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;end_exclude&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;spectrum&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;spectrum&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;energy-loss [eV]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;probability [ppm]&#39;</span><span class="p">);</span>  
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;filename&#39;: &#39;B.K1&#39;, &#39;excl before&#39;: 5, &#39;excl after&#39;: 50, &#39;onset&#39;: 188.0, &#39;factor&#39;: 1.0, &#39;shape&#39;: &#39;hydrogenic&#39;}
{&#39;filename&#39;: &#39;N.K1&#39;, &#39;excl before&#39;: 5, &#39;excl after&#39;: 50, &#39;onset&#39;: 401.6, &#39;factor&#39;: 1.0, &#39;shape&#39;: &#39;hydrogenic&#39;}
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c98552686f40427993b1991894eacf10", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
<section id="the-fit">
<h3><span class="section-number">3.5.6.2. </span>The Fit<a class="headerlink" href="#the-fit" title="Permalink to this heading">#</a></h3>
<p>The function <strong>model</strong> just sums the weighted cross-sections and the background.</p>
<p>The background consists of the power-lawbackground before plus a polynomial component allowing for <em>a variation of the exponent <span class="math notranslate nohighlight">\(r\)</span> of the power-law</em>.</p>
<p>The least square fit is weighted by the noise according to Poison statistic <span class="math notranslate nohighlight">\(\sqrt{I(\Delta E)}\)</span>.</p>
<blockquote>
<div><p>Please note that the cross sections are for single atoms only and do not cover any solid state effects vsible as strong peaks in the first 50 eV or so past the onset.</p>
<p>We exclude those parts from the fits.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;spectrum&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;spectrum&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;energy-loss [eV]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;probability [ppm]&#39;</span><span class="p">);</span>  

<span class="n">regions</span> <span class="o">=</span> <span class="n">ieels</span><span class="o">.</span><span class="n">RegionSelector</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">regions</span><span class="o">.</span><span class="n">set_regions</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mf">50.</span><span class="p">)</span>
                                  
<span class="n">regions</span><span class="o">.</span><span class="n">set_regions</span><span class="p">(</span><span class="s1">&#39;fit region&#39;</span><span class="p">,</span><span class="n">bgdStart</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bgdStart</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
2
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "54712eefa39c4fbdb0674b27c7dc7b50", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">region_tags</span> <span class="o">=</span> <span class="n">regions</span><span class="o">.</span><span class="n">get_regions</span><span class="p">()</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">main_dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1">#startx = np.searchsorted(tags[&#39;energy_scale&#39;],region_tags[&#39;fit_area&#39;][&#39;start_x&#39;])</span>
                            
<span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">startx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">region_tags</span><span class="p">:</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">region_tags</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;start_x&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">region_tags</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;width_x&#39;</span><span class="p">]</span>
    <span class="n">startx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span><span class="n">region_tags</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;start_x&#39;</span><span class="p">])</span>
    <span class="n">endx</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;fit_area&#39;</span><span class="p">:</span>
        <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">startx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">endx</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">startx</span><span class="p">:</span><span class="n">endx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>



<span class="n">pin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.001</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">energy_scale</span>

<span class="n">blurred</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">blurred</span><span class="o">*</span><span class="mf">1e-6</span><span class="o">/</span><span class="n">dispersion</span> <span class="c1">## now in probability</span>
<span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span><span class="o">&lt;</span><span class="mf">1e-8</span><span class="p">)]</span><span class="o">=</span><span class="mf">1e-8</span>


<span class="n">B_Xsection</span> <span class="o">=</span> <span class="n">eels</span><span class="o">.</span><span class="n">xsec_xrpa</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>  <span class="mf">10.</span> <span class="p">)</span><span class="o">/</span><span class="mf">1e10</span>  
<span class="n">N_Xsection</span> <span class="o">=</span> <span class="n">eels</span><span class="o">.</span><span class="n">xsec_xrpa</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>  <span class="mf">10.</span> <span class="p">)</span><span class="o">/</span><span class="mf">1e10</span>       <span class="c1">#  xsec  is in barns = 10^-28 m2 = 10^-10 nm2</span>

<span class="n">xsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">B_Xsection</span><span class="p">,</span> <span class="n">N_Xsection</span><span class="p">])</span>
<span class="n">numberOfEdges</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">residuals</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">):</span>
    <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">))</span><span class="o">*</span><span class="n">mask</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">err</span>        

<span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>  
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">])))</span> <span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">x</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfEdges</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">xsec</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="n">p</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span>  <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="p">)</span>
 
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;B/N ratio is </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#the B atom areal density of a single layer of h-BN (18.2 nm−2) </span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; B areal density is </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> atoms per square nm, which equates </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">18.2</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> atomic layers&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; N areal density is </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> atoms per square nm, which equates </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">18.2</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> atomic layers&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>B/N ratio is 0.964
 B areal density is 122 atoms per square nm, which equates 6.7 atomic layers
 N areal density is 127 atoms per square nm, which equates 7.0 atomic layers
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">region_tags</span> <span class="o">=</span> <span class="n">regions</span><span class="o">.</span><span class="n">get_regions</span><span class="p">()</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">main_dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1">#startx = np.searchsorted(tags[&#39;energy_scale&#39;],region_tags[&#39;fit_area&#39;][&#39;start_x&#39;])</span>
                            
<span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">startx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">region_tags</span><span class="p">:</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">region_tags</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;start_x&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">region_tags</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;width_x&#39;</span><span class="p">]</span>
    <span class="n">startx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span><span class="n">region_tags</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;start_x&#39;</span><span class="p">])</span>
    <span class="n">endx</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;fit_area&#39;</span><span class="p">:</span>
        <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">startx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">endx</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">startx</span><span class="p">:</span><span class="n">endx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>



<span class="n">pin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1e12</span><span class="p">,</span><span class="mf">1e12</span><span class="p">,</span><span class="mf">.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.001</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">energy_scale</span>

<span class="n">blurred</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">blurred</span> <span class="o">*</span> <span class="p">(</span><span class="n">I0</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">/</span><span class="n">dispersion</span> <span class="c1">## now in counts</span>
<span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span><span class="o">&lt;</span><span class="mf">1e-8</span><span class="p">)]</span><span class="o">=</span><span class="mf">1e-8</span>


<span class="n">B_Xsection</span> <span class="o">=</span> <span class="n">eels</span><span class="o">.</span><span class="n">xsec_xrpa</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>  <span class="mf">40.</span> <span class="p">)</span><span class="o">/</span><span class="mf">1e10</span>  
<span class="n">N_Xsection</span> <span class="o">=</span> <span class="n">eels</span><span class="o">.</span><span class="n">xsec_xrpa</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>  <span class="mf">40.</span> <span class="p">)</span><span class="o">/</span><span class="mf">1e10</span>       <span class="c1">#  xsec  is in barns = 10^-28 m2 = 10^-10 nm2</span>

<span class="n">xsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">B_Xsection</span><span class="p">,</span> <span class="n">N_Xsection</span><span class="p">])</span>
<span class="n">numberOfEdges</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">residuals</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">):</span>
    <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">))</span><span class="o">*</span><span class="n">mask</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">err</span>        

<span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>  
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">])))</span> <span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">x</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfEdges</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">xsec</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="n">p</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span>  <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="p">)</span>
 
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The multipliers of X-sections are: </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2E</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2E</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;B/N ratio is </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1">#the B atom areal density of a single layer of h-BN (18.2 nm−2) </span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; B areal density is </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">I0</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> atoms per square nm, which equates </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">I0</span><span class="p">)</span><span class="o">/</span><span class="mf">18.2</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> atomic layers&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; N areal density is </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">I0</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> atoms per square nm, which equates </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">I0</span><span class="p">)</span><span class="o">/</span><span class="mf">18.2</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> atomic layers&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The multipliers of X-sections are: 1.63E+12, 1.68E+12
B/N ratio is 0.972
 B areal density is 47 atoms per square nm, which equates 2.6 atomic layers
 N areal density is 48 atoms per square nm, which equates 2.7 atomic layers
</pre></div>
</div>
</div>
</div>
</section>
<section id="plotting-of-the-fit">
<h3><span class="section-number">3.5.6.3. </span>Plotting of the fit<a class="headerlink" href="#plotting-of-the-fit" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_spectrum</span> <span class="o">=</span>  <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="c1"># in ppm</span>
<span class="n">model_background</span> <span class="o">=</span>  <span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">]))</span> <span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="c1"># in ppm</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="c1">#plt.plot(energy_scale, spectrum* (I0*1e-6)/0.25, label=&#39;spectrum&#39;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">blurred</span><span class="o">*</span> <span class="p">(</span><span class="n">I0</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">/</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;blurred spectrum&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">model_spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">main_dataset</span><span class="o">-</span><span class="n">model_spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;difference&#39;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">model_background</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;background&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;energy-loss [eV]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;probability [ppm]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "13b3f7a87e3947fa8be4fd85ae0670a3", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
</section>
<section id="id1">
<h2><span class="section-number">3.5.7. </span>Summary<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h2>
<p>We use a cross section in unsits of nm<span class="math notranslate nohighlight">\(^2\)</span> and a calibrated spectrum to fit a cross section to each edge.</p>
<p>The fitting parameter is then the areal density of the element.</p>
<p>We only fit the part of the spectrum we know which is the single atom part of the edge, and avoid to fit any solid state effects at the onset of the edge.</p>
<p>The interpreation of solid state effects at the onset are discussed in the <a class="reference internal" href="CH4_10-ELNES.html"><span class="doc std std-doc">energy-loss near-edge structure (ELNES)</span></a> notebook.</p>
</section>
<section id="navigation">
<h2><span class="section-number">3.5.8. </span>Navigation<a class="headerlink" href="#navigation" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><font size = "3">  <strong>Up Chapter 4: <a class="reference internal" href="CH4_00-Spectroscopy.html"><span class="doc std std-doc">Imaging</span></a></strong> </font></p></li>
<li><p><font size = "3">  <strong>Back: <a class="reference internal" href="CH4_07-Introduction_Core_Loss.html"><span class="doc std std-doc">Introduction to Core-Loss</span></a></strong> </font></p></li>
<li><p><font size = "3">  <strong>Next: <a class="reference internal" href="CH4_09-Analyse_Core_Loss.html"><span class="doc std std-doc">Analysis of Core-Loss</span></a></strong> </font></p></li>
<li><p><font size = "3">  <strong>List of Content: <a class="reference internal" href="../_MSE672_Intro_TEM.html"><span class="doc std std-doc">Front</span></a></strong> </font></p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "pyter"
        },
        kernelOptions: {
            name: "pyter",
            path: "./Spectroscopy"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'pyter'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="CH4_07-Introduction_Core_Loss.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">3.4. </span>Introduction to Core-Loss Spectroscopy</p>
      </div>
    </a>
    <a class="right-next"
       href="CH4_09-Analyse_Core_Loss.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">3.6. </span>Analysis of Core-Loss Spectra</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#content">3.5.1. Content</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-important-packages">3.5.2. Load important packages</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-installed-packages">3.5.2.1. Check Installed Packages</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-all-relevant-libraries">3.5.2.2. Import all relevant libraries</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chemical-composition">3.5.3. Chemical Composition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background-fitting">3.5.3.1. Background Fitting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background-fitting-spatial-difference">3.5.3.2. Background Fitting: Spatial Difference</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background-subtraction-errors">3.5.3.3. Background Subtraction Errors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-section">3.5.3.4. Cross-Section</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculation-of-the-cross-section">3.5.3.5. Calculation of the Cross–Section</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">3.5.3.6. Summary</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-and-plot-a-spectrum">3.5.4. Load and plot a spectrum</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#which-elements-are-present">3.5.4.1. Which elements are present</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#probability-scale-of-y-axis">3.5.4.2. Probability scale of y-axis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#intensity-to-probability-calibration">3.5.4.3. Intensity to Probability Calibration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#components-of-a-core-loss-spectrum">3.5.5. Components of a core loss spectrum</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-of-cross-sections-and-spectrum">3.5.5.1. Plotting of cross sections and spectrum</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background">3.5.5.2. Background</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-a-spectrum">3.5.6. Fitting a Spectrum</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-the-fitting-mask">3.5.6.1. Preparing the fitting mask</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-fit">3.5.6.2. The Fit</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-of-the-fit">3.5.6.3. Plotting of the fit</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">3.5.7. Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#navigation">3.5.8. Navigation</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Gerd Duscher UTK/IAMM
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>